!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tensorflow/tfjs-core")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-core"],e):e((t=t||self).faceapi=t.faceapi||{},t.tf)}(this,function(t,C){"use strict";function _(e,n,r,o){return void 0===r&&(r="same"),void 0===o&&(o=!1),C.tidy(function(){var t=C.add(C.conv2d(e,n.filters,[1,1],r),n.bias);return o?C.relu(t):t})}function x(t,n){Object.keys(t).forEach(function(e){n.some(function(t){return t.originalPath===e})||t[e].dispose()})}function p(a,c){return function(t,e,n,r){var o=C.tensor4d(a(t*e*n*n),[n,n,t,e]),i=C.tensor1d(a(e));return c.push({paramPath:r+"/filters"},{paramPath:r+"/bias"}),{filters:o,bias:i}}}function l(i,a){return function(t,e,n){var r=C.tensor2d(i(t*e),[t,e]),o=C.tensor1d(i(e));return a.push({paramPath:n+"/weights"},{paramPath:n+"/bias"}),{weights:r,bias:o}}}var u=function(t,e,n){this.depthwise_filter=t,this.pointwise_filter=e,this.bias=n};function e(a,c){return function(t,e,n){var r=C.tensor4d(a(9*t),[3,3,t,1]),o=C.tensor4d(a(t*e),[1,1,t,e]),i=C.tensor1d(a(e));return c.push({paramPath:n+"/depthwise_filter"},{paramPath:n+"/pointwise_filter"},{paramPath:n+"/bias"}),new u(r,o,i)}}function o(o){return function(t){var e=o(t+"/depthwise_filter",4),n=o(t+"/pointwise_filter",4),r=o(t+"/bias",1);return new u(e,n,r)}}var i=function(){function t(t,e){if(!g(t)||!g(e))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:t,height:e}));this._width=t,this._height=e}return Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),t.prototype.reverse=function(){return new t(1/this.width,1/this.height)},t}(),E=function(){function e(t,e){this._x=t,this._y=e}return Object.defineProperty(e.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.sub=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.mul=function(t){return new e(this.x*t.x,this.y*t.y)},e.prototype.div=function(t){return new e(this.x/t.x,this.y/t.y)},e.prototype.abs=function(){return new e(Math.abs(this.x),Math.abs(this.y))},e.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},e.prototype.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},e}();function a(t,e){return t instanceof C.Tensor&&t.shape.length===e}function P(t){return a(t,2)}function c(t){return a(t,3)}function f(t){return a(t,4)}function h(t){return t%1!=0}function d(t){return t%2==0}function m(t,e){void 0===e&&(e=2);var n=Math.pow(10,e);return Math.floor(t*n)/n}function r(t){return t&&t.width&&t.height}function n(t,e){var n=t.width,r=t.height,o=e/Math.max(r,n);return new i(Math.round(n*o),Math.round(r*o))}function v(t){return t.reduce(function(t,e){return t.add(e)},new E(0,0)).div(new E(t.length,t.length))}function s(t,n,r){return Array(t).fill(0).map(function(t,e){return n+e*r})}function g(t){return!!t&&t!==1/0&&t!==-1/0&&!isNaN(t)||0===t}function b(t){return g(t)&&0<=t&&t<=1}function y(o,i){return function(t,e,n){var r=o[t];if(!a(r,e))throw new Error("expected weightMap["+t+"] to be a Tensor"+e+"D, instead have "+r);return i.push({originalPath:t,paramPath:n||t}),r}}function F(t){var n=t;return{extractWeights:function(t){var e=n.slice(0,t);return n=n.slice(t),e},getRemainingWeights:function(){return n}}}function w(t,e){var n=e+"-weights_manifest.json";if(!t)return{modelBaseUri:"",manifestUri:n};if("/"===t)return{modelBaseUri:"/",manifestUri:"/"+n};var r=t.startsWith("http://")?"http://":t.startsWith("https://")?"https://":"",o=(t=t.replace(r,"")).split("/").filter(function(t){return t}),i=t.endsWith(".json")?o[o.length-1]:n,a=r+(t.endsWith(".json")?o.slice(0,o.length-1):o).join("/");return{modelBaseUri:a=t.startsWith("/")?"/"+a:a,manifestUri:"/"===a?"/"+i:a+"/"+i}}var M=function(t,e){return(M=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function D(t,e){function n(){this.constructor=t}M(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var I=function(){return(I=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function T(i,a,c,s){return new(c||(c=Promise))(function(t,e){function n(t){try{o(s.next(t))}catch(t){e(t)}}function r(t){try{o(s.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new c(function(t){t(e.value)}).then(n,r)}o((s=s.apply(i,a||[])).next())})}function O(n,r){var o,i,a,t,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(a=2&e[0]?i.return:e[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,e[1])).done)return a;switch(i=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,i=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){c.label=e[1];break}if(6===e[0]&&c.label<a[1]){c.label=a[1],a=e;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(e);break}a[2]&&c.ops.pop(),c.trys.pop();continue}e=r.call(n,c)}catch(t){e=[6,t],i=0}finally{o=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var S,j=function(){function f(t,e){void 0===e&&(e=!1);var n=t||{},r=[n.left,n.top,n.right,n.bottom].every(g),o=[n.x,n.y,n.width,n.height].every(g);if(!o&&!r)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(n));var i=o?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top],a=i[0],c=i[1],s=i[2],u=i[3];f.assertIsValidBox({x:a,y:c,width:s,height:u},"Box.constructor",e),this._x=a,this._y=c,this._width=s,this._height=u}return f.isRect=function(t){return!!t&&[t.x,t.y,t.width,t.height].every(g)},f.assertIsValidBox=function(t,e,n){if(void 0===n&&(n=!1),!f.isRect(t))throw new Error(e+" - invalid box: "+JSON.stringify(t)+", expected object with properties x, y, width, height");if(!n&&(t.width<0||t.height<0))throw new Error(e+" - width ("+t.width+") and height ("+t.height+") must be positive numbers")},Object.defineProperty(f.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(f.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),f.prototype.round=function(){var t=[this.x,this.y,this.width,this.height].map(function(t){return Math.round(t)});return new f({x:t[0],y:t[1],width:t[2],height:t[3]})},f.prototype.floor=function(){var t=[this.x,this.y,this.width,this.height].map(function(t){return Math.floor(t)});return new f({x:t[0],y:t[1],width:t[2],height:t[3]})},f.prototype.toSquare=function(){var t=this.x,e=this.y,n=this.width,r=this.height,o=Math.abs(n-r);return n<r&&(t-=o/2,n+=o),r<n&&(e-=o/2,r+=o),new f({x:t,y:e,width:n,height:r})},f.prototype.rescale=function(t){var e=r(t)?t.width:t,n=r(t)?t.height:t;return new f({x:this.x*e,y:this.y*n,width:this.width*e,height:this.height*n})},f.prototype.pad=function(t,e){var n=[this.x-t/2,this.y-e/2,this.width+t,this.height+e];return new f({x:n[0],y:n[1],width:n[2],height:n[3]})},f.prototype.clipAtImageBorders=function(t,e){var n=this.x,r=this.y,o=this.right,i=this.bottom,a=Math.max(n,0),c=Math.max(r,0),s=o-a,u=i-c;return new f({x:a,y:c,width:Math.min(s,t-a),height:Math.min(u,e-c)}).floor()},f.prototype.shift=function(t,e){var n=this.width,r=this.height;return new f({x:this.x+t,y:this.y+e,width:n,height:r})},f.prototype.padAtBorders=function(t,e){var n=this.width+1,r=this.height+1,o=n,i=r,a=this.left,c=this.top,s=this.right,u=this.bottom;return e<s&&(o=-s+e+n,s=e),t<u&&(i=-u+t+r,u=t),a<1&&(i=2-a,a=1),c<1&&(i=2-c,c=1),{dy:1,edy:i,dx:1,edx:o,y:c,ey:u,x:a,ex:s,w:n,h:r}},f.prototype.calibrate=function(t){return new f({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()},f}(),L=function(o){function t(t,e,n,r){return o.call(this,{left:t,top:e,right:n,bottom:r})||this}return D(t,o),t}(j),k=function(){function n(t,e,n,r,o){this._imageDims=new i(o.width,o.height),this._score=t,this._classScore=e,this._className=n,this._box=new j(r).rescale(this._imageDims)}return Object.defineProperty(n.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"relativeBox",{get:function(){return new j(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),n.prototype.forSize=function(t,e){return new n(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:e})},n}();function N(){var t=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:window?window.OffscreenCanvas:self?self.OffscreenCanvas:HTMLCanvasElement,Image:window?window.HTMLImageElement:self?self.HTMLImageElement:null,ImageData:ImageData,Video:window?window.HTMLVideoElement:self?self.HTMLVideoElement:null,createCanvasElement:function(){return window&&"OffscreenCanvas"in window||self&&"OffscreenCanvas"in self?new OffscreenCanvas(1,1):document?document.createElement("canvas"):{}},createImageElement:function(){return document?document.createElement("img"):{}},fetch:t,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function B(e){var n="";if(!e)try{e=require("fs")}catch(t){n=t.toString()}return{readFile:e?function(t){return new Promise(function(n,r){e.readFile(t,function(t,e){return t?r(t):n(e)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+n)}}}function W(){var t=global.Canvas||global.HTMLCanvasElement,e=global.Image||global.HTMLImageElement,n=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},r=B();return I({Canvas:t||function(){},Image:e||function(){},ImageData:global.ImageData||function(){},Video:global.HTMLVideoElement||function(){},createCanvasElement:function(){if(t)return new t;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(e)return new e;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:n},r)}function A(){return!("object"!=typeof window&&"object"!=typeof self||"undefined"==typeof OffscreenCanvas&&"undefined"==typeof HTMLCanvasElement||"undefined"==typeof ImageData)}function z(){return"object"==typeof global&&"function"==typeof require&&"undefined"!=typeof module&&"undefined"!=typeof process&&!!process.version}function R(t){S=t}function H(){A()&&R(N()),z()&&R(W())}var V={getEnv:function(){if(!S)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return S},setEnv:R,initialize:H,createBrowserEnv:N,createFileSystem:B,createNodejsEnv:W,monkeyPatch:function(t){if(S||H(),!S)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var e=t.Canvas,n=void 0===e?S.Canvas:e,r=t.Image,o=void 0===r?S.Image:r;S.Canvas=n,S.Image=o,S.createCanvasElement=t.createCanvasElement||function(){return new n},S.createImageElement=t.createImageElement||function(){return new o},S.ImageData=t.ImageData||S.ImageData,S.Video=t.Video||S.Video,S.fetch=t.fetch||S.fetch,S.readFile=t.readFile||S.readFile},isBrowser:A,isNodejs:z};function Y(t){var e=V.getEnv(),n=e.Image,r=e.Video;return t instanceof n&&t.complete||t instanceof r&&3<=t.readyState}function U(t){return new Promise(function(e,n){if(t instanceof V.getEnv().Canvas||Y(t))return e();function r(t){t.currentTarget&&(t.currentTarget.removeEventListener("load",r),t.currentTarget.removeEventListener("error",o),e(t))}function o(t){t.currentTarget&&(t.currentTarget.removeEventListener("load",r),t.currentTarget.removeEventListener("error",o),n(t))}t.addEventListener("load",r),t.addEventListener("error",o)})}function q(t){return new Promise(function(e,n){if(!(t instanceof Blob))return n("bufferToImage - expected buf to be of type: Blob");var r=new FileReader;r.onload=function(){if("string"!=typeof r.result)return n("bufferToImage - expected reader.result to be a string, in onload");var t=V.getEnv().createImageElement();t.onload=function(){return e(t)},t.onerror=n,t.src=r.result},r.onerror=n,r.readAsDataURL(t)})}function J(t){var e=t.getContext("2d");if(!e)throw new Error("canvas 2d context is null");return e}function G(t){var e=V.getEnv(),n=e.Image,r=e.Video;return t instanceof n?new i(t.naturalWidth,t.naturalHeight):t instanceof r?new i(t.videoWidth,t.videoHeight):new i(t.width,t.height)}function X(t){var e=t.width,n=t.height,r=(0,V.getEnv().createCanvasElement)();return r.width=e,r.height=n,r}function Z(t,e){var n=V.getEnv().ImageData;if(!(t instanceof n||Y(t)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var r=e||G(t),o=r.width,i=r.height,a=X({width:o,height:i});return t instanceof n?J(a).putImageData(t,0,0):J(a).drawImage(t,0,0,o,i),a}function K(t){return void 0===t&&(t={}),Object.assign({},{boxColor:"blue",textColor:"red",lineWidth:2,fontSize:20,fontStyle:"Georgia",withScore:!0,withClassName:!0},t)}function Q(t,e,n,r,o,i){var a=Object.assign(K(),i||{});t.strokeStyle=a.boxColor,t.lineWidth=a.lineWidth,t.strokeRect(e,n,r,o)}H();var $=function(r){function t(t,e){var n=r.call(this,t)||this;return n._text=e,n}return D(t,r),Object.defineProperty(t.prototype,"text",{get:function(){return this._text},enumerable:!0,configurable:!0}),t}(j),tt=function(r){function t(t,e){var n=r.call(this,t)||this;return n._label=e,n}return D(t,r),t.assertIsValidLabeledBox=function(t,e){if(j.assertIsValidBox(t,e),!g(t.label))throw new Error(e+" - expected property label ("+t.label+") to be a number")},Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),t}(j),et=function(i){function t(t,e,n,r){var o=i.call(this,t,e)||this;return o._score=n,o._classScore=r,o}return D(t,i),t.assertIsValidPredictedBox=function(t,e){if(tt.assertIsValidLabeledBox(t,e),!b(t.score)||!b(t.classScore))throw new Error(e+" - expected properties score ("+t.score+") and ("+t.classScore+") to be a number between [0, 1]")},Object.defineProperty(t.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),t}(tt);function nt(t,e,n,r,o){void 0===o&&(o={});var i=Object.assign(K(),o),a=2+i.lineWidth;t.fillStyle=i.textColor,t.font=i.fontSize+"px "+i.fontStyle,t.fillText(r,e+a,n+a+.6*i.fontSize)}function rt(t){return V.isNodejs()||"string"!=typeof t?t:document.getElementById(t)}function ot(n,r){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return[4,(0,V.getEnv().fetch)(n,r)];case 1:if(!((e=t.sent()).status<400))throw new Error("failed to fetch: ("+e.status+") "+e.statusText+", from url: "+e.url);return[2,e]}})})}function it(e){return T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,ot(e)];case 1:return[2,t.sent().json()]}})})}function at(c,s){return T(this,void 0,void 0,function(){var e,n,r,o,i,a;return O(this,function(t){switch(t.label){case 0:return e=s||V.getEnv().createCanvasElement(),n=c.shape.slice(f(c)?1:0),r=n[0],o=n[1],i=n[2],a=C.tidy(function(){return c.as3D(r,o,i).toInt()}),[4,C.toPixels(a,e)];case 1:return t.sent(),a.dispose(),[2,e]}})})}function ct(t,e,n){void 0===n&&(n=!1);var r=V.getEnv(),o=r.Image,i=r.Canvas;if(!(t instanceof o||t instanceof i))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var a=G(t),c=e/Math.max(a.height,a.width),s=c*a.width,u=c*a.height,f=X({width:e,height:e}),h=t instanceof i?t:Z(t),p=Math.abs(s-u)/2,l=n&&s<u?p:0,d=n&&u<s?p:0;return J(f).drawImage(h,l,d,s,u),f}function st(t){var e=V.getEnv(),n=e.Image,r=e.Canvas,o=e.Video;return n&&t instanceof n||r&&t instanceof r||o&&t instanceof o}function ut(i,a){return T(this,void 0,void 0,function(){var e,n,r,o;return O(this,function(t){switch(t.label){case 0:return e=w(i,a),n=e.manifestUri,r=e.modelBaseUri,[4,it(n)];case 1:return o=t.sent(),[2,C.io.loadWeights(o,r)]}})})}function ft(f,h){return void 0===h&&(h=!1),C.tidy(function(){var t=f.shape.slice(1),e=t[0],n=t[1];if(e===n)return f;var r=Math.abs(e-n),o=Math.round(r*(h?.5:1)),i=n<e?2:1,a=function(t){var e=f.shape.slice();return e[i]=t,C.fill(e,0)},c=a(o),s=r-c.shape[i],u=[h&&s?a(s):null,f,c].filter(function(t){return!!t}).map(function(t){return t.toFloat()});return C.concat(u,i)})}var ht=function(){function t(t,e){void 0===e&&(e=!1);var o=this;if(this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(t))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+t);this._treatAsBatchInput=e,this._batchSize=t.length,t.forEach(function(t,e){if(c(t))return o._imageTensors[e]=t,void(o._inputDimensions[e]=t.shape);if(f(t)){var n=t.shape[0];if(1!==n)throw new Error("NetInput - tf.Tensor4D with batchSize "+n+" passed, but not supported in input array");return o._imageTensors[e]=t,void(o._inputDimensions[e]=t.shape.slice(1))}var r=t instanceof V.getEnv().Canvas?t:Z(t);o._canvases[e]=r,o._inputDimensions[e]=[r.height,r.width,3]})}return Object.defineProperty(t.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isBatchInput",{get:function(){return 1<this.batchSize||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"reshapedInputDimensions",{get:function(){var n=this;return s(this.batchSize,0,1).map(function(t,e){return n.getReshapedInputDimensions(e)})},enumerable:!0,configurable:!0}),t.prototype.getInput=function(t){return this.canvases[t]||this.imageTensors[t]},t.prototype.getInputDimensions=function(t){return this._inputDimensions[t]},t.prototype.getInputHeight=function(t){return this._inputDimensions[t][0]},t.prototype.getInputWidth=function(t){return this._inputDimensions[t][1]},t.prototype.getReshapedInputDimensions=function(t){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return n({width:this.getInputWidth(t),height:this.getInputHeight(t)},this.inputSize)},t.prototype.toBatchTensor=function(r,o){var i=this;return void 0===o&&(o=!0),this._inputSize=r,C.tidy(function(){var t=s(i.batchSize,0,1).map(function(t){var e=i.getInput(t);if(e instanceof C.Tensor){var n=f(e)?e:e.expandDims();return(n=ft(n,o)).shape[1]===r&&n.shape[2]===r||(n=C.image.resizeBilinear(n,[r,r])),n.as3D(r,r,3)}if(e instanceof V.getEnv().Canvas)return C.fromPixels(ct(e,r,o));throw new Error("toBatchTensor - at batchIdx "+t+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+e)});return C.stack(t.map(function(t){return t.toFloat()})).as4D(i.batchSize,r,r,3)})},t}();function pt(n){return T(this,void 0,void 0,function(){var r,o,e;return O(this,function(t){switch(t.label){case 0:if(n instanceof ht)return[2,n];if(!(r=Array.isArray(n)?n:[n]).length)throw new Error("toNetInput - empty array passed as input");return o=function(t){return Array.isArray(n)?" at input index "+t+":":""},(e=r.map(rt)).forEach(function(t,e){if(!c(t)&&!f(t)&&!st(t)){if("string"==typeof r[e])throw new Error("toNetInput -"+o(e)+" string passed, but could not resolve HTMLElement for element id "+r[e]);throw new Error("toNetInput -"+o(e)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(f(t)){var n=t.shape[0];if(1!==n)throw new Error("toNetInput -"+o(e)+" tf.Tensor4D with batchSize "+n+" passed, but not supported in input array")}}),[4,Promise.all(e.map(function(t){return st(t)&&U(t)}))];case 1:return t.sent(),[2,new ht(e,Array.isArray(n))]}})})}var lt=function(){function t(t){this._name=t,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(t.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),t.prototype.getParamFromPath=function(t){var e=this.traversePropertyPath(t);return e.obj[e.objProp]},t.prototype.reassignParamFromPath=function(t,e){var n=this.traversePropertyPath(t),r=n.obj,o=n.objProp;r[o].dispose(),r[o]=e},t.prototype.getParamList=function(){var n=this;return this._paramMappings.map(function(t){var e=t.paramPath;return{path:e,tensor:n.getParamFromPath(e)}})},t.prototype.getTrainableParams=function(){return this.getParamList().filter(function(t){return t.tensor instanceof C.Variable})},t.prototype.getFrozenParams=function(){return this.getParamList().filter(function(t){return!(t.tensor instanceof C.Variable)})},t.prototype.variable=function(){var r=this;this.getFrozenParams().forEach(function(t){var e=t.path,n=t.tensor;r.reassignParamFromPath(e,n.variable())})},t.prototype.freeze=function(){var o=this;this.getTrainableParams().forEach(function(t){var e=t.path,n=t.tensor,r=C.tensor(n.dataSync());n.dispose(),o.reassignParamFromPath(e,r)})},t.prototype.dispose=function(e){void 0===e&&(e=!0),this.getParamList().forEach(function(t){if(e&&t.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+t.path);t.tensor.dispose()}),this._params=void 0},t.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(t){var e=t.tensor;return Array.from(e.dataSync())}).reduce(function(t,e){return t.concat(e)}))},t.prototype.load=function(e){return T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return e instanceof Float32Array?(this.extractWeights(e),[2]):[4,this.loadFromUri(e)];case 1:return t.sent(),[2]}})})},t.prototype.loadFromUri=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:if(n&&"string"!=typeof n)throw new Error(this._name+".loadFromUri - expected model uri");return[4,ut(n,this.getDefaultModelName())];case 1:return e=t.sent(),this.loadFromWeightMap(e),[2]}})})},t.prototype.loadFromDisk=function(h){return T(this,void 0,void 0,function(){var e,n,r,o,i,a,c,s,u,f;return O(this,function(t){switch(t.label){case 0:if(h&&"string"!=typeof h)throw new Error(this._name+".loadFromDisk - expected model file path");return e=V.getEnv().readFile,n=w(h,this.getDefaultModelName()),r=n.manifestUri,o=n.modelBaseUri,i=function(t){return Promise.all(t.map(function(t){return e(t).then(function(t){return t.buffer})}))},a=C.io.weightsLoaderFactory(i),u=(s=JSON).parse,[4,e(r)];case 1:return c=u.apply(s,[t.sent().toString()]),[4,a(c,o)];case 2:return f=t.sent(),this.loadFromWeightMap(f),[2]}})})},t.prototype.loadFromWeightMap=function(t){var e=this.extractParamsFromWeigthMap(t),n=e.paramMappings,r=e.params;this._paramMappings=n,this._params=r},t.prototype.extractWeights=function(t){var e=this.extractParams(t),n=e.paramMappings,r=e.params;this._paramMappings=n,this._params=r},t.prototype.traversePropertyPath=function(n){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var t=n.split("/").reduce(function(t,e){if(!t.nextObj.hasOwnProperty(e))throw new Error("traversePropertyPath - object does not have property "+e+", for path "+n);return{obj:t.nextObj,objProp:e,nextObj:t.nextObj[e]}},{nextObj:this.params}),e=t.obj,r=t.objProp;if(!(e&&r&&e[r]instanceof C.Tensor))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+n);return{obj:e,objProp:r}},t}();function dt(t,e,n){void 0===n&&(n=!0);var r=Math.max(0,Math.min(t.right,e.right)-Math.max(t.left,e.left))*Math.max(0,Math.min(t.bottom,e.bottom)-Math.max(t.top,e.top));return n?r/(t.area+e.area-r):r/Math.min(t.area,e.area)}function vt(c,t,s,u){void 0===u&&(u=!0);for(var f=t.map(function(t,e){return{score:t,boxIndex:e}}).sort(function(t,e){return t.score-e.score}).map(function(t){return t.boxIndex}),h=[],e=function(){var t=f.pop();h.push(t);for(var e=f,n=[],r=0;r<e.length;r++){var o=e[r],i=c[t],a=c[o];n.push(dt(i,a,u))}f=f.filter(function(t,e){return n[e]<=s})};0<f.length;)e();return h}function mt(c,s){return C.tidy(function(){var t=s[0],e=s[1],n=s[2],r=C.fill(c.shape.slice(0,3).concat([1]),t),o=C.fill(c.shape.slice(0,3).concat([1]),e),i=C.fill(c.shape.slice(0,3).concat([1]),n),a=C.concat([r,o,i],3);return C.sub(c,a)})}function gt(t){return 1/(1+Math.exp(-t))}var bt,yt,wt=function(t){return"number"==typeof t};function _t(t){if(!t)throw new Error("invalid config: "+t);if("boolean"!=typeof t.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+t.withSeparableConvs);if(!wt(t.iouThreshold)||t.iouThreshold<0||1<t.iouThreshold)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+t.iouThreshold);if(!Array.isArray(t.classes)||!t.classes.length||!t.classes.every(function(t){return"string"==typeof t}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(t.classes));if(!Array.isArray(t.anchors)||!t.anchors.length||!t.anchors.map(function(t){return t||{}}).every(function(t){return wt(t.x)&&wt(t.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(t.anchors));if(t.meanRgb&&(!Array.isArray(t.meanRgb)||3!==t.meanRgb.length||!t.meanRgb.every(wt)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(t.meanRgb))}function xt(e){return C.tidy(function(){var t=C.mul(e,C.scalar(.10000000149011612));return C.add(C.relu(C.sub(e,t)),t)})}function Pt(e,n){return C.tidy(function(){var t=C.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return t=C.conv2d(t,n.conv.filters,[1,1],"valid"),t=C.sub(t,n.bn.sub),t=C.mul(t,n.bn.truediv),xt(t=C.add(t,n.conv.bias))})}function Et(e,n){return C.tidy(function(){var t=C.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return t=C.separableConv2d(t,n.depthwise_filter,n.pointwise_filter,[1,1],"valid"),xt(t=C.add(t,n.bias))})}function Ft(c,s){var u=p(c,s);var t=e(c,s);return{extractConvParams:u,extractConvWithBatchNormParams:function(t,e,n){var r,o,i,a;return{conv:u(t,e,3,n+"/conv"),bn:(r=e,o=n+"/bn",i=C.tensor1d(c(r)),a=C.tensor1d(c(r)),s.push({paramPath:o+"/sub"},{paramPath:o+"/truediv"}),{sub:i,truediv:a})}},extractSeparableConvParams:t}}function Mt(t,e){var n=y(t,e);function r(t){return{filters:n(t+"/filters",4),bias:n(t+"/bias",1)}}return{extractConvParams:r,extractConvWithBatchNormParams:function(t){var e;return{conv:r(t+"/conv"),bn:{sub:n((e=t+"/bn")+"/sub",1),truediv:n(e+"/truediv",1)}}},extractSeparableConvParams:o(n)}}(yt=bt||(bt={}))[yt.XS=224]="XS",yt[yt.SM=320]="SM",yt[yt.MD=416]="MD",yt[yt.LG=608]="LG";var Dt=function(){function t(t){var e=void 0===t?{}:t,n=e.inputSize,r=e.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=n||416,this._scoreThreshold=r||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||1<=this._scoreThreshold)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(t.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),t}(),Tt=function(n){function r(t){var e=n.call(this,"TinyYolov2")||this;return _t(t),e._config=t,e}return D(r,n),Object.defineProperty(r.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"withClassScores",{get:function(){return this.config.withClassScores||1<this.config.classes.length},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),r.prototype.runTinyYolov2=function(t,e){var n=Pt(t,e.conv0);return n=Pt(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv1),n=Pt(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv2),n=Pt(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv3),n=Pt(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv4),n=Pt(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv5),_(n=Pt(n=Pt(n=C.maxPool(n,[2,2],[1,1],"same"),e.conv6),e.conv7),e.conv8,"valid",!1)},r.prototype.runMobilenet=function(t,e){var n=this.config.isFirstLayerConv2d?xt(_(t,e.conv0,"valid",!1)):Et(t,e.conv0);return n=Et(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv1),n=Et(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv2),n=Et(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv3),n=Et(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv4),n=Et(n=C.maxPool(n,[2,2],[2,2],"same"),e.conv5),n=C.maxPool(n,[2,2],[1,1],"same"),n=e.conv6?Et(n,e.conv6):n,_(n=e.conv7?Et(n,e.conv7):n,e.conv8,"valid",!1)},r.prototype.forwardInput=function(e,n){var r=this,o=this.params;if(!o)throw new Error("TinyYolov2 - load model before inference");return C.tidy(function(){var t=e.toBatchTensor(n,!1).toFloat();return t=(t=r.config.meanRgb?mt(t,r.config.meanRgb):t).div(C.scalar(256)),r.config.withSeparableConvs?r.runMobilenet(t,o):r.runTinyYolov2(t,o)})},r.prototype.forward=function(n,r){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[4,e.apply(this,[t.sent(),r])];case 2:return[2,t.sent()]}})})},r.prototype.detect=function(v,m){return void 0===m&&(m={}),T(this,void 0,void 0,function(){var e,n,r,o,i,a,c,s,u,f,h,p,l,d=this;return O(this,function(t){switch(t.label){case 0:return e=new Dt(m),n=e.inputSize,r=e.scoreThreshold,[4,pt(v)];case 1:return o=t.sent(),[4,this.forwardInput(o,n)];case 2:return i=t.sent(),a=C.tidy(function(){return C.unstack(i)[0].expandDims()}),c={width:o.getInputWidth(0),height:o.getInputHeight(0)},s=this.extractBoxes(a,o.getReshapedInputDimensions(0),r),i.dispose(),a.dispose(),u=s.map(function(t){return t.box}),f=s.map(function(t){return t.score}),h=s.map(function(t){return t.classScore}),p=s.map(function(t){return d.config.classes[t.label]}),l=vt(u.map(function(t){return t.rescale(n)}),f,this.config.iouThreshold,!0),[2,l.map(function(t){return new k(f[t],h[t],p[t],u[t],c)})]}})})},r.prototype.getDefaultModelName=function(){return""},r.prototype.extractParamsFromWeigthMap=function(t){return function(t,e){var n,r=[],o=Mt(t,r),i=o.extractConvParams,a=o.extractConvWithBatchNormParams,c=o.extractSeparableConvParams;if(e.withSeparableConvs){var s=e.filterSizes&&e.filterSizes.length||9;n={conv0:e.isFirstLayerConv2d?i("conv0"):c("conv0"),conv1:c("conv1"),conv2:c("conv2"),conv3:c("conv3"),conv4:c("conv4"),conv5:c("conv5"),conv6:7<s?c("conv6"):void 0,conv7:8<s?c("conv7"):void 0,conv8:i("conv8")}}else n={conv0:a("conv0"),conv1:a("conv1"),conv2:a("conv2"),conv3:a("conv3"),conv4:a("conv4"),conv5:a("conv5"),conv6:a("conv6"),conv7:a("conv7"),conv8:i("conv8")};return x(t,r),{params:n,paramMappings:r}}(t,this.config)},r.prototype.extractParams=function(t){var e=this.config.filterSizes||r.DEFAULT_FILTER_SIZES,n=e?e.length:void 0;if(7!==n&&8!==n&&9!==n)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+n+" filterSizes in config");return function(t,e,n,r){var o,i=F(t),a=i.extractWeights,c=i.getRemainingWeights,s=[],u=Ft(a,s),f=u.extractConvParams,h=u.extractConvWithBatchNormParams,p=u.extractSeparableConvParams;if(e.withSeparableConvs){var l=r[0],d=r[1],v=r[2],m=r[3],g=r[4],b=r[5],y=r[6],w=r[7],_=r[8];o={conv0:e.isFirstLayerConv2d?f(l,d,3,"conv0"):p(l,d,"conv0"),conv1:p(d,v,"conv1"),conv2:p(v,m,"conv2"),conv3:p(m,g,"conv3"),conv4:p(g,b,"conv4"),conv5:p(b,y,"conv5"),conv6:w?p(y,w,"conv6"):void 0,conv7:_?p(w,_,"conv7"):void 0,conv8:f(_||w||y,5*n,1,"conv8")}}else l=r[0],d=r[1],v=r[2],m=r[3],g=r[4],b=r[5],y=r[6],w=r[7],_=r[8],o={conv0:h(l,d,"conv0"),conv1:h(d,v,"conv1"),conv2:h(v,m,"conv2"),conv3:h(m,g,"conv3"),conv4:h(g,b,"conv4"),conv5:h(b,y,"conv5"),conv6:h(y,w,"conv6"),conv7:h(w,_,"conv7"),conv8:f(_,5*n,1,"conv8")};if(0!==c().length)throw new Error("weights remaing after extract: "+c().length);return{params:o,paramMappings:s}}(t,this.config,this.boxEncodingSize,e)},r.prototype.extractBoxes=function(e,t,n){for(var r=this,o=t.width,i=t.height,a=Math.max(o,i),c=a/o,s=a/i,u=e.shape[1],f=this.config.anchors.length,h=C.tidy(function(){var t=e.reshape([u,u,f,r.boxEncodingSize]);return[t.slice([0,0,0,0],[u,u,f,4]),t.slice([0,0,0,4],[u,u,f,1]),r.withClassScores?C.softmax(t.slice([0,0,0,5],[u,u,f,r.config.classes.length]),3):C.scalar(0)]}),p=h[0],l=h[1],d=h[2],v=[],m=0;m<u;m++)for(var g=0;g<u;g++)for(var b=0;b<f;b++){var y=gt(l.get(m,g,b,0));if(!n||n<y){var w=(g+gt(p.get(m,g,b,0)))/u*c,_=(m+gt(p.get(m,g,b,1)))/u*s,x=Math.exp(p.get(m,g,b,2))*this.config.anchors[b].x/u*c,P=Math.exp(p.get(m,g,b,3))*this.config.anchors[b].y/u*s,E=w-x/2,F=_-P/2,M={row:m,col:g,anchor:b},D=this.withClassScores?this.extractPredictedClass(d,M):{classScore:1,label:0},T=D.classScore,S=D.label;v.push(I({box:new L(E,F,E+x,F+P),score:y,classScore:y*T,label:S},M))}}return p.dispose(),l.dispose(),d.dispose(),v},r.prototype.extractPredictedClass=function(n,t){var r=t.row,o=t.col,i=t.anchor;return Array(this.config.classes.length).fill(0).map(function(t,e){return n.get(r,o,i,e)}).map(function(t,e){return{classScore:t,label:e}}).reduce(function(t,e){return t.classScore>e.classScore?t:e})},r.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],r}(lt),St=Object.freeze({convLayer:_,disposeUnusedWeightTensors:x,extractConvParamsFactory:p,extractFCParamsFactory:l,extractSeparableConvParamsFactory:e,loadSeparableConvParamsFactory:o,extractWeightEntryFactory:y,extractWeightsFactory:F,getModelUris:w,SeparableConvParams:u,TinyYolov2:Tt,get TinyYolov2SizeType(){return bt},TinyYolov2Options:Dt,validateConfig:_t}),Ct=function(o){function t(t,e,n,r){return o.call(this,{x:t,y:e,width:n,height:r})||this}return D(t,o),t}(j),It=function(r){function t(t,e,n){return r.call(this,t,t,"",e,n)||this}return D(t,r),t.prototype.forSize=function(t,e){return r.prototype.forSize.call(this,t,e)},t}(k),Ot=function(){function t(t,e,n){void 0===n&&(n=new E(0,0));var r=e.width,o=e.height;this._imgDims=new i(r,o),this._shift=n,this._positions=t.map(function(t){return t.mul(new E(r,o)).add(n)})}return Object.defineProperty(t.prototype,"shift",{get:function(){return new E(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"relativePositions",{get:function(){var e=this;return this._positions.map(function(t){return t.sub(e._shift).div(new E(e.imageWidth,e.imageHeight))})},enumerable:!0,configurable:!0}),t.prototype.forSize=function(t,e){return new this.constructor(this.relativePositions,{width:t,height:e})},t.prototype.shiftBy=function(t,e){return new this.constructor(this.relativePositions,this._imgDims,new E(t,e))},t.prototype.shiftByPoint=function(t){return this.shiftBy(t.x,t.y)},t.prototype.align=function(t){if(t){var e=t instanceof It?t.box.floor():t;return this.shiftBy(e.x,e.y).align()}var n=this.getRefPointsForAlignment(),r=n[0],o=n[1],i=n[2],a=function(t){return i.sub(t).magnitude()},c=(a(r)+a(o))/2,s=Math.floor(c/.45),u=v(n),f=Math.floor(Math.max(0,u.x-.5*s)),h=Math.floor(Math.max(0,u.y-.43*s));return new Ct(f,h,Math.min(s,this.imageWidth+f),Math.min(s,this.imageHeight+h))},t.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},t}(),jt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.getRefPointsForAlignment=function(){var t=this.positions;return[t[0],t[1],v([t[3],t[4]])]},e}(Ot),Lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.getJawOutline=function(){return this.positions.slice(0,17)},e.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},e.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},e.prototype.getNose=function(){return this.positions.slice(27,36)},e.prototype.getLeftEye=function(){return this.positions.slice(36,42)},e.prototype.getRightEye=function(){return this.positions.slice(42,48)},e.prototype.getMouth=function(){return this.positions.slice(48,68)},e.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(v)},e}(Ot),kt=function(){function t(t,e){this._label=t,this._distance=e}return Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),t.prototype.toString=function(t){return void 0===t&&(t=!0),this.label+(t?" ("+m(this.distance)+")":"")},t}(),Nt=function(){function t(t,e){if("string"!=typeof t)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(function(t){return!(t instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=t,this._descriptors=e}return Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),t}();function Bt(i,a,t){if(void 0===t&&(t=!1),i.beginPath(),a.slice(1).forEach(function(t,e){var n=t.x,r=t.y,o=a[e];i.moveTo(o.x,o.y),i.lineTo(n,r)}),t){var e=a[a.length-1],n=a[0];if(!e||!n)return;i.moveTo(e.x,e.y),i.lineTo(n.x,n.y)}i.stroke()}function Wt(c,s){return T(this,void 0,void 0,function(){var e,n,r,o,i,a;return O(this,function(t){switch(t.label){case 0:return e=V.getEnv().Canvas,(n=c)instanceof e?[3,5]:[4,pt(c)];case 1:if(1<(r=t.sent()).batchSize)throw new Error("extractFaces - batchSize > 1 not supported");return(o=r.getInput(0))instanceof e?(i=o,[3,4]):[3,2];case 2:return[4,at(o)];case 3:i=t.sent(),t.label=4;case 4:n=i,t.label=5;case 5:return a=J(n),[2,s.map(function(t){return t instanceof It?t.forSize(n.width,n.height).box.floor():t}).map(function(t){return t.clipAtImageBorders(n.width,n.height)}).map(function(t){var e=t.x,n=t.y,r=t.width,o=t.height,i=X({width:r,height:o});return J(i).putImageData(a.getImageData(e,n,r,o),0,0),i})]}})})}function At(s,e){return T(this,void 0,void 0,function(){return O(this,function(t){if(!c(s)&&!f(s))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(f(s)&&1<s.shape[0])throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,C.tidy(function(){var t=s.shape.slice(f(s)?1:0),i=t[0],a=t[1],c=t[2];return e.map(function(t){return t instanceof It?t.forSize(a,i).box:t}).map(function(t){return t.clipAtImageBorders(a,i)}).map(function(t){var e=t.x,n=t.y,r=t.width,o=t.height;return C.slice3d(s.as3D(i,a,c),[n,e,0],[o,r,c])})})]})})}function zt(e,n,r){return C.tidy(function(){var t=C.separableConv2d(e,n.depthwise_filter,n.pointwise_filter,r,"same");return t=C.add(t,n.bias)})}function Rt(r,o,i){return void 0===i&&(i=!1),C.tidy(function(){var t=C.relu(i?C.add(C.conv2d(r,o.conv0.filters,[2,2],"same"),o.conv0.bias):zt(r,o.conv0,[2,2])),e=zt(t,o.conv1,[1,1]),n=zt(C.relu(C.add(t,e)),o.conv2,[1,1]);return C.relu(C.add(t,C.add(e,n)))})}function Ht(o,i,a,c){return void 0===a&&(a=!1),void 0===c&&(c=!0),C.tidy(function(){var t=C.relu(a?C.add(C.conv2d(o,i.conv0.filters,c?[2,2]:[1,1],"same"),i.conv0.bias):zt(o,i.conv0,c?[2,2]:[1,1])),e=zt(t,i.conv1,[1,1]),n=zt(C.relu(C.add(t,e)),i.conv2,[1,1]),r=zt(C.relu(C.add(t,C.add(e,n))),i.conv3,[1,1]);return C.relu(C.add(t,C.add(e,C.add(n,r))))})}function Vt(a,c){function i(t,e,n){var r=C.tensor4d(a(9*t),[3,3,t,1]),o=C.tensor4d(a(t*e),[1,1,t,e]),i=C.tensor1d(a(e));return c.push({paramPath:n+"/depthwise_filter"},{paramPath:n+"/pointwise_filter"},{paramPath:n+"/bias"}),new u(r,o,i)}var o=p(a,c);function s(t,e,n,r){return void 0===r&&(r=!1),{conv0:r?o(t,e,3,n+"/conv0"):i(t,e,n+"/conv0"),conv1:i(e,e,n+"/conv1"),conv2:i(e,e,n+"/conv2")}}return{extractDenseBlock3Params:s,extractDenseBlock4Params:function(t,e,n,r){void 0===r&&(r=!1);var o=s(t,e,n,r);return{conv0:o.conv0,conv1:o.conv1,conv2:o.conv2,conv3:i(e,e,n+"/conv3")}}}}function Yt(t,e){var o=y(t,e);function n(t){return{filters:o(t+"/filters",4),bias:o(t+"/bias",1)}}function r(t){var e=o(t+"/depthwise_filter",4),n=o(t+"/pointwise_filter",4),r=o(t+"/bias",1);return new u(e,n,r)}return{extractDenseBlock3Params:function(t,e){return void 0===e&&(e=!1),{conv0:e?n(t+"/conv0"):r(t+"/conv0"),conv1:r(t+"/conv1"),conv2:r(t+"/conv2")}},extractDenseBlock4Params:function(t,e){return void 0===e&&(e=!1),{conv0:e?n(t+"/conv0"):r(t+"/conv0"),conv1:r(t+"/conv1"),conv2:r(t+"/conv2"),conv3:r(t+"/conv3")}}}}var Ut=function(t){function e(){return t.call(this,"FaceFeatureExtractor")||this}return D(e,t),e.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return C.tidy(function(){var t=Ht(mt(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(C.scalar(255)),n.dense0,!0);return t=Ht(t=Ht(t=Ht(t,n.dense1),n.dense2),n.dense3),t=C.avgPool(t,[7,7],[2,2],"valid")})},e.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},e.prototype.extractParamsFromWeigthMap=function(t){return r=Yt(e=t,n=[]).extractDenseBlock4Params,o={dense0:r("dense0",!0),dense1:r("dense1"),dense2:r("dense2"),dense3:r("dense3")},x(e,n),{params:o,paramMappings:n};var e,n,r,o},e.prototype.extractParams=function(t){return function(t){var e=[],n=F(t),r=n.extractWeights,o=n.getRemainingWeights,i=Vt(r,e).extractDenseBlock4Params,a=i(3,32,"dense0",!0),c=i(32,64,"dense1"),s=i(64,128,"dense2"),u=i(128,256,"dense3");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:e,params:{dense0:a,dense1:c,dense2:s,dense3:u}}}(t)},e}(lt);function qt(t,e){return C.tidy(function(){return C.add(C.matMul(t,e.weights),e.bias)})}var Jt=function(r){function t(t,e){var n=r.call(this,t)||this;return n._faceFeatureExtractor=e,n}return D(t,r),Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,r=this.params;if(!r)throw new Error(this._name+" - load model before inference");return C.tidy(function(){var t=e instanceof ht?n.faceFeatureExtractor.forwardInput(e):e;return qt(t.as2D(t.shape[0],-1),r.fc)})},t.prototype.dispose=function(t){void 0===t&&(t=!0),this.faceFeatureExtractor.dispose(t),r.prototype.dispose.call(this,t)},t.prototype.loadClassifierParams=function(t){var e=this.extractClassifierParams(t),n=e.params,r=e.paramMappings;this._params=n,this._paramMappings=r},t.prototype.extractClassifierParams=function(t){return function(t,e,n){var r=[],o=F(t),i=o.extractWeights,a=o.getRemainingWeights,c=l(i,r)(e,n,"fc");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:r,params:{fc:c}}}(t,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},t.prototype.extractParamsFromWeigthMap=function(t){var e,n,r,o,i,a,c,s,u=(e=t,n={},r={},Object.keys(e).forEach(function(t){(t.startsWith("fc")?r:n)[t]=e[t]}),{featureExtractorMap:n,classifierMap:r}),f=u.featureExtractorMap,h=u.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(f),c=y(o=h,a=[]),s={fc:(i="fc",{weights:c(i+"/weights",2),bias:c(i+"/bias",1)})},x(o,a),{params:s,paramMappings:a}},t.prototype.extractParams=function(t){var e=this.getClassifierChannelsIn(),n=this.getClassifierChannelsOut(),r=n*e+n,o=t.slice(0,t.length-r),i=t.slice(t.length-r);return this.faceFeatureExtractor.extractWeights(o),this.extractClassifierParams(i)},t}(lt),Gt={neutral:0,happy:1,sad:2,angry:3,fearful:4,disgusted:5,surprised:6},Xt=function(e){function c(t){return void 0===t&&(t=new Ut),e.call(this,"FaceExpressionNet",t)||this}return D(c,e),c.getFaceExpressionLabel=function(t){var e=Gt[t];if("number"!=typeof e)throw new Error("getFaceExpressionLabel - no label for faceExpression: "+t);return e},c.decodeProbabilites=function(e){if(7!==e.length)throw new Error("decodeProbabilites - expected probabilities.length to be 7, have: "+e.length);return Object.keys(Gt).map(function(t){return{expression:t,probability:e[Gt[t]]}})},c.prototype.forwardInput=function(t){var e=this;return C.tidy(function(){return C.softmax(e.runNet(t))})},c.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},c.prototype.predictExpressions=function(a){return T(this,void 0,void 0,function(){var e,n,r,o,i=this;return O(this,function(t){switch(t.label){case 0:return[4,pt(a)];case 1:return e=t.sent(),[4,this.forwardInput(e)];case 2:return n=t.sent(),[4,Promise.all(C.unstack(n).map(function(n){return T(i,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return[4,n.data()];case 1:return e=t.sent(),n.dispose(),[2,e]}})})}))];case 3:return r=t.sent(),n.dispose(),o=r.map(function(t){return c.decodeProbabilites(t)}),[2,e.isBatchInput?o:o[0]]}})})},c.prototype.getDefaultModelName=function(){return"face_expression_model"},c.prototype.getClassifierChannelsIn=function(){return 256},c.prototype.getClassifierChannelsOut=function(){return 7},c}(Jt),Zt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.postProcess=function(t,o,e){var i=e.map(function(t){var e=t.width,n=t.height,r=o/Math.max(n,e);return{width:e*r,height:n*r}}),a=i.length;return C.tidy(function(){var n=function(t,e){return C.stack([C.fill([68],t),C.fill([68],e)],1).as2D(1,136).as1D()},r=function(t,e){var n=i[t],r=n.width,o=n.height;return e(r,o)?Math.abs(r-o)/2:0};return t.mul(C.fill([a,136],o)).sub(C.stack(Array.from(Array(a),function(t,e){return n(r(e,function(t,e){return t<e}),r(e,function(t,e){return e<t}))}))).div(C.stack(Array.from(Array(a),function(t,e){return n(i[e].width,i[e].height)})))})},e.prototype.forwardInput=function(e){var n=this;return C.tidy(function(){var t=n.runNet(e);return n.postProcess(t,e.inputSize,e.inputDimensions.map(function(t){return{height:t[0],width:t[1]}}))})},e.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.detectLandmarks=function(o){return T(this,void 0,void 0,function(){var s,e,n,r=this;return O(this,function(t){switch(t.label){case 0:return[4,pt(o)];case 1:return s=t.sent(),e=C.tidy(function(){return C.unstack(r.forwardInput(s))}),[4,Promise.all(e.map(function(a,c){return T(r,void 0,void 0,function(){var e,n,r,o,i;return O(this,function(t){switch(t.label){case 0:return r=(n=Array).from,[4,a.data()];case 1:return e=r.apply(n,[t.sent()]),o=e.filter(function(t,e){return d(e)}),i=e.filter(function(t,e){return!d(e)}),[2,new Lt(Array(68).fill(0).map(function(t,e){return new E(o[e],i[e])}),{height:s.getInputHeight(c),width:s.getInputWidth(c)})]}})})}))];case 2:return n=t.sent(),e.forEach(function(t){return t.dispose()}),[2,s.isBatchInput?n:n[0]]}})})},e.prototype.getClassifierChannelsOut=function(){return 136},e}(Jt),Kt=function(e){function t(t){return void 0===t&&(t=new Ut),e.call(this,"FaceLandmark68Net",t)||this}return D(t,e),t.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t}(Zt);var Qt=function(t){function e(){return t.call(this,"TinyFaceFeatureExtractor")||this}return D(e,t),e.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return C.tidy(function(){var t=Rt(mt(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(C.scalar(255)),n.dense0,!0);return t=Rt(t=Rt(t,n.dense1),n.dense2),t=C.avgPool(t,[14,14],[2,2],"valid")})},e.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},e.prototype.extractParamsFromWeigthMap=function(t){return r=Yt(e=t,n=[]).extractDenseBlock3Params,o={dense0:r("dense0",!0),dense1:r("dense1"),dense2:r("dense2")},x(e,n),{params:o,paramMappings:n};var e,n,r,o},e.prototype.extractParams=function(t){return function(t){var e=[],n=F(t),r=n.extractWeights,o=n.getRemainingWeights,i=Vt(r,e).extractDenseBlock3Params,a=i(3,32,"dense0",!0),c=i(32,64,"dense1"),s=i(64,128,"dense2");if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:e,params:{dense0:a,dense1:c,dense2:s}}}(t)},e}(lt),$t=function(e){function t(t){return void 0===t&&(t=new Qt),e.call(this,"FaceLandmark68TinyNet",t)||this}return D(t,e),t.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},t.prototype.getClassifierChannelsIn=function(){return 128},t}(Zt),te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e}(Kt);function ee(t,e,n,r,o){void 0===o&&(o="same");var i,a,c=e.conv,s=c.filters,u=c.bias,f=C.conv2d(t,s,n,o);return f=C.add(f,u),i=f,a=e.scale,f=C.add(C.mul(i,a.weights),a.biases),r?C.relu(f):f}function ne(t,e){return ee(t,e,[1,1],!1)}function re(t,e){return ee(t,e,[2,2],!0,"valid")}function oe(s,u){function f(t,e,n,r){var o=function(t,e,n){var r=s(t),o=r.length/(e*n*n);if(h(o))throw new Error("depth has to be an integer: "+o+", weights.length: "+r.length+", numFilters: "+e+", filterSize: "+n);return C.tidy(function(){return C.transpose(C.tensor4d(r,[e,o,n,n]),[2,3,1,0])})}(t,e,n),i=C.tensor1d(s(e));return u.push({paramPath:r+"/filters"},{paramPath:r+"/bias"}),{filters:o,bias:i}}function i(t,e,n,r){var o,i,a,c;return{conv:f(t,e,n,r+"/conv"),scale:(o=e,i=r+"/scale",a=C.tensor1d(s(o)),c=C.tensor1d(s(o)),u.push({paramPath:i+"/weights"},{paramPath:i+"/biases"}),{weights:a,biases:c})}}return{extractConvLayerParams:i,extractResidualLayerParams:function(t,e,n,r,o){return void 0===o&&(o=!1),{conv1:i((o?.5:1)*t,e,n,r+"/conv1"),conv2:i(t,e,n,r+"/conv2")}}}}function ie(t,e){var n=y(t,e);function r(t){var e;return{conv:{filters:n(t+"/conv/filters",4),bias:n(t+"/conv/bias",1)},scale:{weights:n((e=t)+"/scale/weights",1),biases:n(e+"/scale/biases",1)}}}return{extractConvLayerParams:r,extractResidualLayerParams:function(t){return{conv1:r(t+"/conv1"),conv2:r(t+"/conv2")}}}}function ae(t,e){var n,r,o=(n=t,r=e.conv1,ee(n,r,[1,1],!0));return o=ne(o,e.conv2),o=C.add(o,t),o=C.relu(o)}function ce(t,e){var n=re(t,e.conv1);n=ne(n,e.conv2);var r=C.avgPool(t,2,2,"valid"),o=C.zeros(r.shape),i=r.shape[3]!==n.shape[3];if(r.shape[1]!==n.shape[1]||r.shape[2]!==n.shape[2]){var a=n.shape.slice();a[1]=1;var c=C.zeros(a),s=(n=C.concat([n,c],1)).shape.slice();s[2]=1;var u=C.zeros(s);n=C.concat([n,u],2)}return r=i?C.concat([r,o],3):r,n=C.add(r,n),n=C.relu(n)}var se=function(t){function e(){return t.call(this,"FaceRecognitionNet")||this}return D(e,t),e.prototype.forwardInput=function(n){var r=this.params;if(!r)throw new Error("FaceRecognitionNet - load model before inference");return C.tidy(function(){var t=re(mt(n.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div(C.scalar(256)),r.conv32_down),e=(t=ce(t=ae(t=ae(t=ce(t=ae(t=ae(t=ce(t=ae(t=ae(t=ae(t=ce(t=ae(t=ae(t=ae(t=C.maxPool(t,3,2,"valid"),r.conv32_1),r.conv32_2),r.conv32_3),r.conv64_down),r.conv64_1),r.conv64_2),r.conv64_3),r.conv128_down),r.conv128_1),r.conv128_2),r.conv256_down),r.conv256_1),r.conv256_2),r.conv256_down_out)).mean([1,2]);return C.matMul(e,r.fc)})},e.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.computeFaceDescriptor=function(i){return T(this,void 0,void 0,function(){var e,n,r,o=this;return O(this,function(t){switch(t.label){case 0:return[4,pt(i)];case 1:return e=t.sent(),n=C.tidy(function(){return C.unstack(o.forwardInput(e))}),[4,Promise.all(n.map(function(t){return t.data()}))];case 2:return r=t.sent(),n.forEach(function(t){return t.dispose()}),[2,e.isBatchInput?r:r[0]]}})})},e.prototype.getDefaultModelName=function(){return"face_recognition_model"},e.prototype.extractParamsFromWeigthMap=function(t){return function(t){var e=[],n=ie(t,e),r=n.extractConvLayerParams,o=n.extractResidualLayerParams,i=r("conv32_down"),a=o("conv32_1"),c=o("conv32_2"),s=o("conv32_3"),u=o("conv64_down"),f=o("conv64_1"),h=o("conv64_2"),p=o("conv64_3"),l=o("conv128_down"),d=o("conv128_1"),v=o("conv128_2"),m=o("conv256_down"),g=o("conv256_1"),b=o("conv256_2"),y=o("conv256_down_out"),w=t.fc;if(e.push({originalPath:"fc",paramPath:"fc"}),!P(w))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+w);var _={conv32_down:i,conv32_1:a,conv32_2:c,conv32_3:s,conv64_down:u,conv64_1:f,conv64_2:h,conv64_3:p,conv128_down:l,conv128_1:d,conv128_2:v,conv256_down:m,conv256_1:g,conv256_2:b,conv256_down_out:y,fc:w};return x(t,e),{params:_,paramMappings:e}}(t)},e.prototype.extractParams=function(t){return function(t){var e=F(t),n=e.extractWeights,r=e.getRemainingWeights,o=[],i=oe(n,o),a=i.extractConvLayerParams,c=i.extractResidualLayerParams,s=a(4704,32,7,"conv32_down"),u=c(9216,32,3,"conv32_1"),f=c(9216,32,3,"conv32_2"),h=c(9216,32,3,"conv32_3"),p=c(36864,64,3,"conv64_down",!0),l=c(36864,64,3,"conv64_1"),d=c(36864,64,3,"conv64_2"),v=c(36864,64,3,"conv64_3"),m=c(147456,128,3,"conv128_down",!0),g=c(147456,128,3,"conv128_1"),b=c(147456,128,3,"conv128_2"),y=c(589824,256,3,"conv256_down",!0),w=c(589824,256,3,"conv256_1"),_=c(589824,256,3,"conv256_2"),x=c(589824,256,3,"conv256_down_out"),P=C.tidy(function(){return C.transpose(C.tensor2d(n(32768),[128,256]),[1,0])});if(o.push({paramPath:"fc"}),0!==r().length)throw new Error("weights remaing after extract: "+r().length);return{params:{conv32_down:s,conv32_1:u,conv32_2:f,conv32_3:h,conv64_down:p,conv64_1:l,conv64_2:d,conv64_3:v,conv128_down:m,conv128_1:g,conv128_2:b,conv256_down:y,conv256_1:w,conv256_2:_,conv256_down_out:x,fc:P},paramMappings:o}}(t)},e}(lt);function ue(t,e){var n={descriptor:e};return Object.assign({},t,n)}function fe(t,e){var n={detection:e};return Object.assign({},t,n)}function he(t,e){var n={expressions:e};return Object.assign({},t,n)}function pe(t,e){var n=t.detection.box,r=e.shiftBy(n.x,n.y),o=r.align(),i=t.detection.imageDims,a={landmarks:r,unshiftedLandmarks:e,alignedRect:new It(t.detection.score,o.rescale(i.reverse()),i)};return Object.assign({},t,a)}var le=function(){function t(t){var e=void 0===t?{}:t,n=e.minFaceSize,r=e.scaleFactor,o=e.maxNumScales,i=e.scoreThresholds,a=e.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=n||20,this._scaleFactor=r||.709,this._maxNumScales=o||10,this._scoreThresholds=i||[.6,.7,.7],this._scaleSteps=a,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||1<=this._scaleFactor)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(t){return"number"!=typeof t}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(t){return"number"!=typeof t})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(t.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),t}();function de(f,h){function i(t,e,n,r,o){var i=C.tensor4d(f(t*e*n*n),[n,n,t,e]),a=C.tensor1d(f(e));return h.push({paramPath:r+"/filters"},{paramPath:r+"/"+(o?"batch_norm_offset":"bias")}),{filters:i,bias:a}}function p(t,e,n,r){var o=i(t,e,n,r,!0);return{filters:o.filters,batch_norm_offset:o.bias}}function t(t,e,n){var r,o,i,a,c,s,u;return{depthwise_conv:(r=t,o=n+"/depthwise_conv",i=C.tensor4d(f(9*r),[3,3,r,1]),a=C.tensor1d(f(r)),c=C.tensor1d(f(r)),s=C.tensor1d(f(r)),u=C.tensor1d(f(r)),h.push({paramPath:o+"/filters"},{paramPath:o+"/batch_norm_scale"},{paramPath:o+"/batch_norm_offset"},{paramPath:o+"/batch_norm_mean"},{paramPath:o+"/batch_norm_variance"}),{filters:i,batch_norm_scale:a,batch_norm_offset:c,batch_norm_mean:s,batch_norm_variance:u}),pointwise_conv:p(t,e,1,n+"/pointwise_conv")}}return{extractMobilenetV1Params:function(){return{conv_0:p(3,32,3,"mobilenetv1/conv_0"),conv_1:t(32,64,"mobilenetv1/conv_1"),conv_2:t(64,128,"mobilenetv1/conv_2"),conv_3:t(128,128,"mobilenetv1/conv_3"),conv_4:t(128,256,"mobilenetv1/conv_4"),conv_5:t(256,256,"mobilenetv1/conv_5"),conv_6:t(256,512,"mobilenetv1/conv_6"),conv_7:t(512,512,"mobilenetv1/conv_7"),conv_8:t(512,512,"mobilenetv1/conv_8"),conv_9:t(512,512,"mobilenetv1/conv_9"),conv_10:t(512,512,"mobilenetv1/conv_10"),conv_11:t(512,512,"mobilenetv1/conv_11"),conv_12:t(512,1024,"mobilenetv1/conv_12"),conv_13:t(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:p(1024,256,1,"prediction_layer/conv_0"),conv_1:p(256,512,3,"prediction_layer/conv_1"),conv_2:p(512,128,1,"prediction_layer/conv_2"),conv_3:p(128,256,3,"prediction_layer/conv_3"),conv_4:p(256,128,1,"prediction_layer/conv_4"),conv_5:p(128,256,3,"prediction_layer/conv_5"),conv_6:p(256,64,1,"prediction_layer/conv_6"),conv_7:p(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:i(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:i(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:i(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:i(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:i(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:i(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:i(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:i(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:i(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:i(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:i(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:i(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}function ve(t){var e=[],n=function(t,e){var i=y(t,e);function a(t,e,n){return{filters:i(t+"/Conv2d_"+e+"_pointwise/weights",4,n+"/filters"),batch_norm_offset:i(t+"/Conv2d_"+e+"_pointwise/convolution_bn_offset",1,n+"/batch_norm_offset")}}function n(t){var e="mobilenetv1/conv_"+t,n="MobilenetV1/Conv2d_"+t+"_depthwise",r=e+"/depthwise_conv",o=e+"/pointwise_conv";return{depthwise_conv:{filters:i(n+"/depthwise_weights",4,r+"/filters"),batch_norm_scale:i(n+"/BatchNorm/gamma",1,r+"/batch_norm_scale"),batch_norm_offset:i(n+"/BatchNorm/beta",1,r+"/batch_norm_offset"),batch_norm_mean:i(n+"/BatchNorm/moving_mean",1,r+"/batch_norm_mean"),batch_norm_variance:i(n+"/BatchNorm/moving_variance",1,r+"/batch_norm_variance")},pointwise_conv:a("MobilenetV1",t,o)}}function r(t,e){return{filters:i(t+"/weights",4,e+"/filters"),bias:i(t+"/biases",1,e+"/bias")}}function o(t){return{box_encoding_predictor:r("Prediction/BoxPredictor_"+t+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+t+"/box_encoding_predictor"),class_predictor:r("Prediction/BoxPredictor_"+t+"/ClassPredictor","prediction_layer/box_predictor_"+t+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:a("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:n(1),conv_2:n(2),conv_3:n(3),conv_4:n(4),conv_5:n(5),conv_6:n(6),conv_7:n(7),conv_8:n(8),conv_9:n(9),conv_10:n(10),conv_11:n(11),conv_12:n(12),conv_13:n(13)}},extractPredictionLayerParams:function(){return{conv_0:a("Prediction",0,"prediction_layer/conv_0"),conv_1:a("Prediction",1,"prediction_layer/conv_1"),conv_2:a("Prediction",2,"prediction_layer/conv_2"),conv_3:a("Prediction",3,"prediction_layer/conv_3"),conv_4:a("Prediction",4,"prediction_layer/conv_4"),conv_5:a("Prediction",5,"prediction_layer/conv_5"),conv_6:a("Prediction",6,"prediction_layer/conv_6"),conv_7:a("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:o(0),box_predictor_1:o(1),box_predictor_2:o(2),box_predictor_3:o(3),box_predictor_4:o(4),box_predictor_5:o(5)}}}}(t,e),r=n.extractMobilenetV1Params,o=n.extractPredictionLayerParams,i=t["Output/extra_dim"];if(e.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!c(i))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+i);var a={mobilenetv1:r(),prediction_layer:o(),output_layer:{extra_dim:i}};return x(t,e),{params:a,paramMappings:e}}function me(e,n,r){return C.tidy(function(){var t=C.conv2d(e,n.filters,r,"same");return t=C.add(t,n.batch_norm_offset),C.clipByValue(t,0,6)})}var ge=.0010000000474974513;function be(t,e){return C.tidy(function(){var s=null,u=me(t,e.conv_0,[2,2]);if([e.conv_1,e.conv_2,e.conv_3,e.conv_4,e.conv_5,e.conv_6,e.conv_7,e.conv_8,e.conv_9,e.conv_10,e.conv_11,e.conv_12,e.conv_13].forEach(function(t,e){var n,r,o,i,a=e+1,c=(n=a,[2,4,6,12].some(function(t){return t===n})?[2,2]:[1,1]);r=u,o=t.depthwise_conv,i=c,u=me(u=C.tidy(function(){var t=C.depthwiseConv2d(r,o.filters,i,"same");return t=C.batchNormalization(t,o.batch_norm_mean,o.batch_norm_variance,ge,o.batch_norm_scale,o.batch_norm_offset),C.clipByValue(t,0,6)}),t.pointwise_conv,[1,1]),11===a&&(s=u)}),null===s)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:u,conv11:s}})}function ye(t,e,n){var r=Math.min(t.get(e,0),t.get(e,2)),o=Math.min(t.get(e,1),t.get(e,3)),i=Math.max(t.get(e,0),t.get(e,2)),a=Math.max(t.get(e,1),t.get(e,3)),c=Math.min(t.get(n,0),t.get(n,2)),s=Math.min(t.get(n,1),t.get(n,3)),u=Math.max(t.get(n,0),t.get(n,2)),f=Math.max(t.get(n,1),t.get(n,3)),h=(i-r)*(a-o),p=(u-c)*(f-s);if(h<=0||p<=0)return 0;var l=Math.max(r,c),d=Math.max(o,s),v=Math.min(i,u),m=Math.min(a,f),g=Math.max(v-l,0)*Math.max(m-d,0);return g/(h+p-g)}function we(t,e){var n,r,o,i=(n=t,r=C.unstack(C.transpose(n,[1,0])),{sizes:o=[C.sub(r[2],r[0]),C.sub(r[3],r[1])],centers:[C.add(r[0],C.div(o[0],C.scalar(2))),C.add(r[1],C.div(o[1],C.scalar(2)))]}),a=i.sizes,c=i.centers,s=C.unstack(C.transpose(e,[1,0])),u=C.div(C.mul(C.exp(C.div(s[2],C.scalar(5))),a[0]),C.scalar(2)),f=C.add(C.mul(C.div(s[0],C.scalar(10)),a[0]),c[0]),h=C.div(C.mul(C.exp(C.div(s[3],C.scalar(5))),a[1]),C.scalar(2)),p=C.add(C.mul(C.div(s[1],C.scalar(10)),a[1]),c[1]);return C.transpose(C.stack([C.sub(f,u),C.sub(p,h),C.add(f,u),C.add(p,h)]),[1,0])}function _e(e,n){return C.tidy(function(){var t=e.shape[0];return{boxPredictionEncoding:C.reshape(_(e,n.box_encoding_predictor),[t,-1,1,4]),classPrediction:C.reshape(_(e,n.class_predictor),[t,-1,3])}})}var xe=function(){function t(t){var e=void 0===t?{}:t,n=e.minConfidence,r=e.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=n||.5,this._maxResults=r||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||1<=this._minConfidence)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(t.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),t}(),Pe=function(t){function e(){return t.call(this,"SsdMobilenetv1")||this}return D(e,t),e.prototype.forwardInput=function(s){var u=this.params;if(!u)throw new Error("SsdMobilenetv1 - load model before inference");return C.tidy(function(){var f,h,p,o,i,a,t=s.toBatchTensor(512,!1).toFloat(),e=be(C.sub(C.mul(t,C.scalar(.007843137718737125)),C.scalar(1)),u.mobilenetv1),n=(f=e.out,h=e.conv11,p=u.prediction_layer,C.tidy(function(){var t=me(me(f,p.conv_0,[1,1]),p.conv_1,[2,2]),e=me(me(t,p.conv_2,[1,1]),p.conv_3,[2,2]),n=me(me(e,p.conv_4,[1,1]),p.conv_5,[2,2]),r=me(me(n,p.conv_6,[1,1]),p.conv_7,[2,2]),o=_e(h,p.box_predictor_0),i=_e(f,p.box_predictor_1),a=_e(t,p.box_predictor_2),c=_e(e,p.box_predictor_3),s=_e(n,p.box_predictor_4),u=_e(r,p.box_predictor_5);return{boxPredictions:C.concat([o.boxPredictionEncoding,i.boxPredictionEncoding,a.boxPredictionEncoding,c.boxPredictionEncoding,s.boxPredictionEncoding,u.boxPredictionEncoding],1),classPredictions:C.concat([o.classPrediction,i.classPrediction,a.classPrediction,c.classPrediction,s.classPrediction,u.classPrediction],1)}})),r=n.boxPredictions,c=n.classPredictions;return o=r,i=c,a=u.output_layer,C.tidy(function(){var t=o.shape[0],e=we(C.reshape(C.tile(a.extra_dim,[t,1,1]),[-1,4]),C.reshape(o,[-1,4]));e=C.reshape(e,[t,e.shape[0]/t,4]);var n=C.sigmoid(C.slice(i,[0,0,1],[-1,-1,-1])),r=C.slice(n,[0,0,0],[-1,-1,1]);return r=C.reshape(r,[t,r.shape[1]]),{boxes:C.unstack(e),scores:C.unstack(r)}})})},e.prototype.forward=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent()])]}})})},e.prototype.locateFaces=function(S,C){return void 0===C&&(C={}),T(this,void 0,void 0,function(){var f,h,p,l,d,v,m,g,b,y,w,_,x,P,E,F,M,D,T;return O(this,function(t){switch(t.label){case 0:return f=new xe(C),h=f.maxResults,p=f.minConfidence,[4,pt(S)];case 1:for(l=t.sent(),d=this.forwardInput(l),v=d.boxes,m=d.scores,g=v[0],b=m[0],y=1;y<v.length;y++)v[y].dispose(),m[y].dispose();return x=(_=Array).from,[4,b.data()];case 2:return w=x.apply(_,[t.sent()]),e=w,n=h,i=.5,a=p,r=(o=g).shape[0],c=Math.min(n,r),s=e.map(function(t,e){return{score:t,boxIndex:e}}).filter(function(t){return t.score>a}).sort(function(t,e){return e.score-t.score}),u=[],s.forEach(function(t){if(!(u.length>=c)){for(var e=t.score,n=u.length-1;0<=n;--n){var r=ye(o,t.boxIndex,u[n]);if(0!==r&&(t.score*=r<=i?1:0,t.score<=a))break}e===t.score&&u.push(t.boxIndex)}}),P=u,E=l.getReshapedInputDimensions(0),F=l.inputSize,M=F/E.width,D=F/E.height,T=P.map(function(t){var e=[Math.max(0,g.get(t,0)),Math.min(1,g.get(t,2))].map(function(t){return t*D}),n=e[0],r=e[1],o=[Math.max(0,g.get(t,1)),Math.min(1,g.get(t,3))].map(function(t){return t*M}),i=o[0],a=o[1];return new It(w[t],new Ct(i,n,a-i,r-n),{height:l.getInputHeight(0),width:l.getInputWidth(0)})}),g.dispose(),b.dispose(),[2,T]}var o,e,n,i,a,r,c,s,u})})},e.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},e.prototype.extractParamsFromWeigthMap=function(t){return ve(t)},e.prototype.extractParams=function(t){return function(t){var e=[],n=F(t),r=n.extractWeights,o=n.getRemainingWeights,i=de(r,e),a=i.extractMobilenetV1Params,c=i.extractPredictionLayerParams,s=a(),u=c(),f={extra_dim:C.tensor3d(r(20472),[1,5118,4])};if(e.push({paramPath:"output_layer/extra_dim"}),0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{mobilenetv1:s,prediction_layer:u,output_layer:f},paramMappings:e}}(t)},e}(lt);function Ee(t){var e=new Pe;return e.extractWeights(t),e}var Fe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e}(Pe),Me=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._name="TinyFaceDetectorOptions",t}return D(t,e),t}(Dt),De=function(){function t(){}return t.prototype.then=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=n,[4,this.run()];case 1:return[2,e.apply(void 0,[t.sent()])]}})})},t.prototype.run=function(){return T(this,void 0,void 0,function(){return O(this,function(t){throw new Error("ComposableTask - run is not implemented")})})},t}();var Te=2,Se=12;function Ce(t){var e=F(t),n=e.extractWeights,r=e.getRemainingWeights,o=[],i=function(r,o){var s=p(r,o),u=l(r,o);function f(t,e){var n=C.tensor1d(r(t));return o.push({paramPath:e}),n}function h(t,e,n){return void 0===n&&(n=!1),{conv1:s(t[0],t[1],3,e+"/conv1"),prelu1_alpha:f(t[1],e+"/prelu1_alpha"),conv2:s(t[1],t[2],3,e+"/conv2"),prelu2_alpha:f(t[2],e+"/prelu2_alpha"),conv3:s(t[2],t[3],n?2:3,e+"/conv3"),prelu3_alpha:f(t[3],e+"/prelu3_alpha")}}return{extractPNetParams:function(){var t=h([3,10,16,32],"pnet"),e=s(32,2,1,"pnet/conv4_1"),n=s(32,4,1,"pnet/conv4_2");return I({},t,{conv4_1:e,conv4_2:n})},extractRNetParams:function(){var t=h([3,28,48,64],"rnet",!0),e=u(576,128,"rnet/fc1"),n=f(128,"rnet/prelu4_alpha"),r=u(128,2,"rnet/fc2_1"),o=u(128,4,"rnet/fc2_2");return I({},t,{fc1:e,prelu4_alpha:n,fc2_1:r,fc2_2:o})},extractONetParams:function(){var t=h([3,32,64,64],"onet"),e=s(64,128,2,"onet/conv4"),n=f(128,"onet/prelu4_alpha"),r=u(1152,256,"onet/fc1"),o=f(256,"onet/prelu5_alpha"),i=u(256,2,"onet/fc2_1"),a=u(256,4,"onet/fc2_2"),c=u(256,10,"onet/fc2_3");return I({},t,{conv4:e,prelu4_alpha:n,fc1:r,prelu5_alpha:o,fc2_1:i,fc2_2:a,fc2_3:c})}}}(n,o),a=i.extractPNetParams,c=i.extractRNetParams,s=i.extractONetParams,u=a(),f=c(),h=s();if(0!==r().length)throw new Error("weights remaing after extract: "+r().length);return{params:{pnet:u,rnet:f,onet:h},paramMappings:o}}function Ie(t){var e=[],n=function(t,e){var n=y(t,e);function s(t){return{filters:n(t+"/weights",4,t+"/filters"),bias:n(t+"/bias",1)}}function u(t){return{weights:n(t+"/weights",2),bias:n(t+"/bias",1)}}function f(t){return n(t,1)}function h(t){return{conv1:s(t+"/conv1"),prelu1_alpha:f(t+"/prelu1_alpha"),conv2:s(t+"/conv2"),prelu2_alpha:f(t+"/prelu2_alpha"),conv3:s(t+"/conv3"),prelu3_alpha:f(t+"/prelu3_alpha")}}return{extractPNetParams:function(){var t=h("pnet"),e=s("pnet/conv4_1"),n=s("pnet/conv4_2");return I({},t,{conv4_1:e,conv4_2:n})},extractRNetParams:function(){var t=h("rnet"),e=u("rnet/fc1"),n=f("rnet/prelu4_alpha"),r=u("rnet/fc2_1"),o=u("rnet/fc2_2");return I({},t,{fc1:e,prelu4_alpha:n,fc2_1:r,fc2_2:o})},extractONetParams:function(){var t=h("onet"),e=s("onet/conv4"),n=f("onet/prelu4_alpha"),r=u("onet/fc1"),o=f("onet/prelu5_alpha"),i=u("onet/fc2_1"),a=u("onet/fc2_2"),c=u("onet/fc2_3");return I({},t,{conv4:e,prelu4_alpha:n,fc1:r,prelu5_alpha:o,fc2_1:i,fc2_2:a,fc2_3:c})}}}(t,e),r=n.extractPNetParams,o=n.extractRNetParams,i=n.extractONetParams,a=r(),c=o(),s=i();return x(t,e),{params:{pnet:a,rnet:c,onet:s},paramMappings:e}}function Oe(t,e){var n=e[0],r=e[1];return{height:Math.floor(n*t),width:Math.floor(r*t)}}var je=function(o){function t(t,e,n,r){return o.call(this,{left:t,top:e,right:n,bottom:r},!0)||this}return D(t,o),t}(j);function Le(t){return C.tidy(function(){return C.mul(C.sub(t,C.scalar(127.5)),C.scalar(.0078125))})}function ke(t,e){return C.tidy(function(){return C.add(C.relu(t),C.mul(e,C.neg(C.relu(C.neg(t)))))})}function Ne(e,n,r){return void 0===r&&(r=!1),C.tidy(function(){var t=_(e,n.conv1,"valid");return t=ke(t,n.prelu1_alpha),t=ke(t=_(t=C.maxPool(t,r?[2,2]:[3,3],[2,2],"same"),n.conv2,"valid"),n.prelu2_alpha),t=ke(t=_(t=r?t:C.maxPool(t,[3,3],[2,2],"valid"),n.conv3,"valid"),n.prelu3_alpha)})}function Be(h,t,s,p,u){u.stage1=[];var e=t.map(function(f){return C.tidy(function(){var o,i,r,a,t={scale:f},e=(o=h,i=f,C.tidy(function(){var t=Oe(i,o.shape.slice(1)),e=t.height,n=t.width,r=Le(C.image.resizeBilinear(o,[e,n]));return C.transpose(r,[0,2,1,3])})),n=Date.now(),c=(r=e,a=p,C.tidy(function(){var t=Ne(r,a,!0),e=_(t,a.conv4_1,"valid"),n=C.expandDims(C.max(e,3),3);return{prob:C.softmax(C.sub(e,n),3),regions:_(t,a.conv4_2,"valid")}})),s=c.prob,u=c.regions;return t.pnet=Date.now()-n,{scoresTensor:C.unstack(C.unstack(s,3)[1])[0],regionsTensor:C.unstack(u)[0],scale:f,statsForScale:t}})}).map(function(t){var e=t.scoresTensor,n=t.regionsTensor,r=t.scale,o=t.statsForScale,i=function(e,n,r,t){for(var o=[],i=0;i<e.shape[0];i++)for(var a=0;a<e.shape[1];a++)e.get(i,a)>=t&&o.push(new E(a,i));return o.map(function(t){return{cell:new L(Math.round((t.y*Te+1)/r),Math.round((t.x*Te+1)/r),Math.round((t.y*Te+Se)/r),Math.round((t.x*Te+Se)/r)),score:e.get(t.y,t.x),region:new je(n.get(t.y,t.x,0),n.get(t.y,t.x,1),n.get(t.y,t.x,2),n.get(t.y,t.x,3))}})}(e,n,r,s);if(e.dispose(),n.dispose(),!i.length)return u.stage1.push(o),[];var a=Date.now(),c=vt(i.map(function(t){return t.cell}),i.map(function(t){return t.score}),.5);return o.nms=Date.now()-a,o.numBoxes=c.length,u.stage1.push(o),c.map(function(t){return i[t]})}).reduce(function(t,e){return t.concat(e)},[]),n=[],r=[];if(0<e.length){var o=Date.now(),i=vt(e.map(function(t){return t.cell}),e.map(function(t){return t.score}),.7);u.stage1_nms=Date.now()-o,r=i.map(function(t){return e[t].score}),n=i.map(function(t){return e[t]}).map(function(t){var e=t.cell,n=t.region;return new L(e.left+n.left*e.width,e.top+n.top*e.height,e.right+n.right*e.width,e.bottom+n.bottom*e.height).toSquare().round()})}return{boxes:n,scores:r}}function We(h,r,t){var a=t.width,c=t.height;return T(this,void 0,void 0,function(){var f,e,i,n=this;return O(this,function(t){switch(t.label){case 0:return f=J(h),[4,Promise.all(r.map(function(u){return T(n,void 0,void 0,function(){var e,n,r,o,i,a,c,s;return O(this,function(t){return e=u.padAtBorders(h.height,h.width),n=e.y,r=e.ey,o=e.x,i=e.ex,a=o-1,c=n-1,s=f.getImageData(a,c,i-a,r-c),[2,V.isNodejs()?Z(s):createImageBitmap(s)]})})}))];case 1:return e=t.sent(),i=[],e.forEach(function(t){var e=J(X({width:a,height:c}));e.drawImage(t,0,0,a,c);for(var n=e.getImageData(0,0,a,c).data,r=[],o=0;o<n.length;o+=4)r.push(n[o+2]),r.push(n[o+1]),r.push(n[o]);i.push(r)}),[2,i.map(function(t){return C.tidy(function(){return Le(C.transpose(C.tensor4d(t,[1,a,c,3]),[0,2,1,3]).toFloat())})})]}})})}function Ae(v,m,g,b,y){return T(this,void 0,void 0,function(){var e,n,r,o,i,a,c,s,u,f,h,p,l,d;return O(this,function(t){switch(t.label){case 0:return e=Date.now(),[4,We(v,m,{width:24,height:24})];case 1:return n=t.sent(),y.stage2_extractImagePatches=Date.now()-e,e=Date.now(),r=n.map(function(t){var a,c,e=(a=t,c=b,C.tidy(function(){var t=Ne(a,c),e=ke(qt(C.reshape(t,[t.shape[0],c.fc1.weights.shape[0]]),c.fc1),c.prelu4_alpha),n=qt(e,c.fc2_1),r=C.expandDims(C.max(n,1),1),o=C.softmax(C.sub(n,r),1),i=qt(e,c.fc2_2);return{scores:C.unstack(o,1)[1],regions:i}}));return t.dispose(),e}),y.stage2_rnet=Date.now()-e,o=1<r.length?C.concat(r.map(function(t){return t.scores})):r[0].scores,c=(a=Array).from,[4,o.data()];case 2:return i=c.apply(a,[t.sent()]),o.dispose(),s=i.map(function(t,e){return{score:t,idx:e}}).filter(function(t){return t.score>g}).map(function(t){return t.idx}),u=s.map(function(t){return m[t]}),f=s.map(function(t){return i[t]}),h=[],p=[],0<u.length&&(e=Date.now(),l=vt(u,f,.7),y.stage2_nms=Date.now()-e,d=l.map(function(t){return new je(r[s[t]].regions.get(0,0),r[s[t]].regions.get(0,1),r[s[t]].regions.get(0,2),r[s[t]].regions.get(0,3))}),p=l.map(function(t){return f[t]}),h=l.map(function(t,e){return u[t].calibrate(d[e])})),r.forEach(function(t){t.regions.dispose(),t.scores.dispose()}),[2,{boxes:h,scores:p}]}})})}function ze(m,g,b,y,w){return T(this,void 0,void 0,function(){var e,n,o,r,i,a,c,s,u,f,h,p,l,d,v;return O(this,function(t){switch(t.label){case 0:return e=Date.now(),[4,We(m,g,{width:48,height:48})];case 1:return n=t.sent(),w.stage3_extractImagePatches=Date.now()-e,e=Date.now(),o=n.map(function(t){var c,s,e=(c=t,s=y,C.tidy(function(){var t=Ne(c,s);t=ke(t=_(t=C.maxPool(t,[2,2],[2,2],"same"),s.conv4,"valid"),s.prelu4_alpha);var e=ke(qt(C.reshape(t,[t.shape[0],s.fc1.weights.shape[0]]),s.fc1),s.prelu5_alpha),n=qt(e,s.fc2_1),r=C.expandDims(C.max(n,1),1),o=C.softmax(C.sub(n,r),1),i=qt(e,s.fc2_2),a=qt(e,s.fc2_3);return{scores:C.unstack(o,1)[1],regions:i,points:a}}));return t.dispose(),e}),w.stage3_onet=Date.now()-e,r=1<o.length?C.concat(o.map(function(t){return t.scores})):o[0].scores,c=(a=Array).from,[4,r.data()];case 2:return i=c.apply(a,[t.sent()]),r.dispose(),s=i.map(function(t,e){return{score:t,idx:e}}).filter(function(t){return t.score>b}).map(function(t){return t.idx}),u=s.map(function(t){return new je(o[t].regions.get(0,0),o[t].regions.get(0,1),o[t].regions.get(0,2),o[t].regions.get(0,3))}),f=s.map(function(t,e){return g[t].calibrate(u[e])}),h=s.map(function(t){return i[t]}),p=[],l=[],d=[],0<f.length&&(e=Date.now(),v=vt(f,h,.7,!1),w.stage3_nms=Date.now()-e,p=v.map(function(t){return f[t]}),l=v.map(function(t){return h[t]}),d=v.map(function(n,r){return Array(5).fill(0).map(function(t,e){return new E(o[n].points.get(0,e)*(p[r].width+1)+p[r].left,o[n].points.get(0,e+5)*(p[r].height+1)+p[r].top)})})),o.forEach(function(t){t.regions.dispose(),t.scores.dispose(),t.points.dispose()}),[2,{boxes:p,scores:l,points:d}]}})})}var Re=function(t){function e(){return t.call(this,"Mtcnn")||this}return D(e,t),e.prototype.forwardInput=function(x,P){return void 0===P&&(P={}),T(this,void 0,void 0,function(){var e,n,r,o,i,a,c,s,u,f,h,p,l,d,v,m,g,b,y,w,_;return O(this,function(t){switch(t.label){case 0:if(!(e=this.params))throw new Error("Mtcnn - load model before inference");if(!(n=x.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return r={},o=Date.now(),i=C.tidy(function(){return t=C.expandDims(C.fromPixels(n)).toFloat(),C.tidy(function(){return C.stack(C.unstack(t,3).reverse(),3)});var t}),a=function(t){return i.dispose(),r.total=Date.now()-o,t},c=i.shape.slice(1),s=c[0],u=c[1],f=new le(P),h=f.minFaceSize,p=f.scaleFactor,l=f.maxNumScales,d=f.scoreThresholds,v=f.scaleSteps,m=(v||function(t,e,n){for(var r=n[0],o=n[1],i=Se/t,a=[],c=Math.min(r,o)*i,s=0;12<=c;)a.push(i*Math.pow(e,s)),c*=e,s+=1;return a}(h,p,[s,u])).filter(function(t){var e=Oe(t,[s,u]);return Math.min(e.width,e.height)>Se}).slice(0,l),r.scales=m,r.pyramid=m.map(function(t){return Oe(t,[s,u])}),g=Date.now(),[4,Be(i,m,d[0],e.pnet,r)];case 1:return b=t.sent(),r.total_stage1=Date.now()-g,b.boxes.length?(r.stage2_numInputBoxes=b.boxes.length,g=Date.now(),[4,Ae(n,b.boxes,d[1],e.rnet,r)]):[2,a({results:[],stats:r})];case 2:return y=t.sent(),r.total_stage2=Date.now()-g,y.boxes.length?(r.stage3_numInputBoxes=y.boxes.length,g=Date.now(),[4,ze(n,y.boxes,d[2],e.onet,r)]):[2,a({results:[],stats:r})];case 3:return w=t.sent(),r.total_stage3=Date.now()-g,_=w.boxes.map(function(e,t){return pe(fe({},new It(w.scores[t],new Ct(e.left/u,e.top/s,e.width/u,e.height/s),{height:s,width:u})),new jt(w.points[t].map(function(t){return t.sub(new E(e.left,e.top)).div(new E(e.width,e.height))}),{width:e.width,height:e.height}))}),[2,a({results:_,stats:r})]}})})},e.prototype.forward=function(n,r){return void 0===r&&(r={}),T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[4,e.apply(this,[t.sent(),r])];case 2:return[2,t.sent().results]}})})},e.prototype.forwardWithStats=function(n,r){return void 0===r&&(r={}),T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=this.forwardInput,[4,pt(n)];case 1:return[2,e.apply(this,[t.sent(),r])]}})})},e.prototype.getDefaultModelName=function(){return"mtcnn_model"},e.prototype.extractParamsFromWeigthMap=function(t){return Ie(t)},e.prototype.extractParams=function(t){return Ce(t)},e}(lt),He=[new E(1.603231,2.094468),new E(6.041143,7.080126),new E(2.882459,3.518061),new E(4.266906,5.178857),new E(9.041765,10.66308)],Ve=[117.001,114.697,97.404],Ye=function(e){function t(){var t={withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:He,meanRgb:Ve,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};return e.call(this,t)||this}return D(t,e),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.detect(e,n)];case 1:return[2,t.sent().map(function(t){return new It(t.score,t.relativeBox,{width:t.imageWidth,height:t.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},t.prototype.extractParamsFromWeigthMap=function(t){return e.prototype.extractParamsFromWeigthMap.call(this,t)},t}(Tt),Ue=[new E(.738768,.874946),new E(2.42204,2.65704),new E(4.30971,7.04493),new E(10.246,4.59428),new E(12.6868,11.8741)],qe=[new E(1.603231,2.094468),new E(6.041143,7.080126),new E(2.882459,3.518061),new E(4.266906,5.178857),new E(9.041765,10.66308)],Je=[117.001,114.697,97.404],Ge=function(n){function t(t){void 0===t&&(t=!0);var e=Object.assign({},{withSeparableConvs:t,iouThreshold:.4,classes:["face"]},t?{anchors:qe,meanRgb:Je}:{anchors:Ue,withClassScores:!0});return n.call(this,e)||this}return D(t,n),Object.defineProperty(t.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.detect(e,n)];case 1:return[2,t.sent().map(function(t){return new It(t.score,t.relativeBox,{width:t.imageWidth,height:t.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},t.prototype.extractParamsFromWeigthMap=function(t){return n.prototype.extractParamsFromWeigthMap.call(this,t)},t}(Tt);var Xe={ssdMobilenetv1:new Pe,tinyFaceDetector:new Ye,tinyYolov2:new Ge,mtcnn:new Re,faceLandmark68Net:new Kt,faceLandmark68TinyNet:new $t,faceRecognitionNet:new se,faceExpressionNet:new Xt},Ze=function(t,e){return Xe.ssdMobilenetv1.locateFaces(t,e)},Ke=function(t){return Xe.faceLandmark68Net.detectLandmarks(t)},Qe=function(t){return Xe.ssdMobilenetv1.load(t)},$e=Qe,tn=Ze,en=Ke,nn=function(r){function t(t,e){var n=r.call(this)||this;return n.parentTask=t,n.input=e,n}return D(t,r),t}(De),rn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,o,r,i,a=this;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return e=t.sent(),n=e.map(function(t){return t.alignedRect}),this.input instanceof C.Tensor?[4,At(this.input,n)]:[3,3];case 2:return r=t.sent(),[3,5];case 3:return[4,Wt(this.input,n)];case 4:r=t.sent(),t.label=5;case 5:return o=r,[4,Promise.all(e.map(function(n,r){return T(a,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return[4,Xe.faceRecognitionNet.computeFaceDescriptor(o[r])];case 1:return e=t.sent(),[2,ue(n,e)]}})})}))];case 6:return i=t.sent(),o.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,i]}})})},e}(nn),on=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o,i;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return(e=t.sent())?(n=e.alignedRect,this.input instanceof C.Tensor?[4,At(this.input,[n])]:[3,3]):[2];case 2:return o=t.sent(),[3,5];case 3:return[4,Wt(this.input,[n])];case 4:o=t.sent(),t.label=5;case 5:return r=o,[4,Xe.faceRecognitionNet.computeFaceDescriptor(r[0])];case 6:return i=t.sent(),r.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,ue(e,i)]}})})},e}(nn),an=function(o){function t(t,e,n){var r=o.call(this)||this;return r.parentTask=t,r.input=e,r.useTinyLandmarkNet=n,r}return D(t,o),Object.defineProperty(t.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?Xe.faceLandmark68TinyNet:Xe.faceLandmark68Net},enumerable:!0,configurable:!0}),t}(De),cn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o,i,a=this;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return e=t.sent(),n=e.map(function(t){return t.detection}),this.input instanceof C.Tensor?[4,At(this.input,n)]:[3,3];case 2:return o=t.sent(),[3,5];case 3:return[4,Wt(this.input,n)];case 4:o=t.sent(),t.label=5;case 5:return r=o,[4,Promise.all(r.map(function(t){return a.landmarkNet.detectLandmarks(t)}))];case 6:return i=t.sent(),r.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,e.map(function(t,e){return pe(t,i[e])})]}})})},e.prototype.withFaceDescriptors=function(){return new rn(this,this.input)},e}(an),sn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o,i;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return(e=t.sent())?(n=e.detection,this.input instanceof C.Tensor?[4,At(this.input,[n])]:[3,3]):[2];case 2:return o=t.sent(),[3,5];case 3:return[4,Wt(this.input,[n])];case 4:o=t.sent(),t.label=5;case 5:return r=o,[4,this.landmarkNet.detectLandmarks(r[0])];case 6:return i=t.sent(),r.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,pe(e,i)]}})})},e.prototype.withFaceDescriptor=function(){return new on(this,this.input)},e}(an),un=function(r){function t(t,e){var n=r.call(this)||this;return n.parentTask=t,n.input=e,n}return D(t,r),t}(De),fn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o,i;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return e=t.sent(),n=e.map(function(t){return t.detection}),this.input instanceof C.Tensor?[4,At(this.input,n)]:[3,3];case 2:return o=t.sent(),[3,5];case 3:return[4,Wt(this.input,n)];case 4:o=t.sent(),t.label=5;case 5:return r=o,[4,Promise.all(r.map(function(t){return Xe.faceExpressionNet.predictExpressions(t)}))];case 6:return i=t.sent(),r.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,e.map(function(t,e){return he(t,i[e])})]}})})},e.prototype.withFaceLandmarks=function(){return new cn(this,this.input,!1)},e}(un),hn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o,i;return O(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return(e=t.sent())?(n=e.detection,this.input instanceof C.Tensor?[4,At(this.input,[n])]:[3,3]):[2];case 2:return o=t.sent(),[3,5];case 3:return[4,Wt(this.input,[n])];case 4:o=t.sent(),t.label=5;case 5:return r=o,[4,Xe.faceExpressionNet.predictExpressions(r[0])];case 6:return i=t.sent(),r.forEach(function(t){return t instanceof C.Tensor&&t.dispose()}),[2,he(e,i)]}})})},e.prototype.withFaceLandmarks=function(){return new sn(this,this.input,!1)},e}(un),pn=function(r){function t(t,e){void 0===e&&(e=new xe);var n=r.call(this)||this;return n.input=t,n.options=e,n}return D(t,r),t}(De),ln=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n,r,o;return O(this,function(t){switch(t.label){case 0:return n=(e=this).input,(r=e.options)instanceof le?[4,Xe.mtcnn.forward(n,r)]:[3,2];case 1:return[2,t.sent().map(function(t){return t.detection})];case 2:if(!(o=r instanceof Me?function(t){return Xe.tinyFaceDetector.locateFaces(t,r)}:r instanceof xe?function(t){return Xe.ssdMobilenetv1.locateFaces(t,r)}:r instanceof Dt?function(t){return Xe.tinyYolov2.locateFaces(t,r)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,o(n)]}})})},e.prototype.runAndExtendWithFaceDetections=function(){var t=this;return new Promise(function(n){return T(t,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return[4,this.run()];case 1:return e=t.sent(),[2,n(e.map(function(t){return fe({},t)}))]}})})})},e.prototype.withFaceLandmarks=function(t){return void 0===t&&(t=!1),new cn(this.runAndExtendWithFaceDetections(),this.input,t)},e.prototype.withFaceExpressions=function(){return new fn(this.runAndExtendWithFaceDetections(),this.input)},e}(pn),dn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return D(e,t),e.prototype.run=function(){return T(this,void 0,void 0,function(){var e,n;return O(this,function(t){switch(t.label){case 0:return[4,new ln(this.input,this.options)];case 1:return e=t.sent(),n=e[0],e.forEach(function(t){t.score>n.score&&(n=t)}),[2,n]}})})},e.prototype.runAndExtendWithFaceDetection=function(){var t=this;return new Promise(function(n){return T(t,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return[4,this.run()];case 1:return e=t.sent(),[2,n(e?fe({},e):void 0)]}})})})},e.prototype.withFaceLandmarks=function(t){return void 0===t&&(t=!1),new sn(this.runAndExtendWithFaceDetection(),this.input,t)},e.prototype.withFaceExpressions=function(){return new hn(this.runAndExtendWithFaceDetection(),this.input)},e}(pn);function vn(t,e){return void 0===e&&(e=new xe),new ln(t,e)}function mn(e,n){return T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,vn(e,new xe(n?{minConfidence:n}:{})).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})}var gn=mn;function bn(t,e){if(t.length!==e.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var n=Array.from(t),r=Array.from(e);return Math.sqrt(n.map(function(t,e){return t-r[e]}).reduce(function(t,e){return t+Math.pow(e,2)},0))}var yn=function(){function t(t,e){void 0===e&&(e=.6),this._distanceThreshold=e;var n=Array.isArray(t)?t:[t];if(!n.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var r=1,o=function(){return"person "+r++};this._labeledDescriptors=n.map(function(t){if(t instanceof Nt)return t;if(t instanceof Float32Array)return new Nt(o(),[t]);if(t.descriptor&&t.descriptor instanceof Float32Array)return new Nt(o(),[t.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}return Object.defineProperty(t.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),t.prototype.computeMeanDistance=function(e,t){return t.map(function(t){return bn(t,e)}).reduce(function(t,e){return t+e},0)/(t.length||1)},t.prototype.matchDescriptor=function(r){var o=this;return this.labeledDescriptors.map(function(t){var e=t.descriptors,n=t.label;return new kt(n,o.computeMeanDistance(r,e))}).reduce(function(t,e){return t.distance<e.distance?t:e})},t.prototype.findBestMatch=function(t){var e=this.matchDescriptor(t);return e.distance<this.distanceThreshold?e:new kt("unknown",e.distance)},t}();t.tf=C,t.TfjsImageRecognitionBase=St,t.BoundingBox=L,t.Box=j,t.BoxWithText=$,t.Dimensions=i,t.LabeledBox=tt,t.ObjectDetection=k,t.Point=E,t.PredictedBox=et,t.Rect=Ct,t.awaitMediaLoaded=U,t.bufferToImage=q,t.createCanvas=X,t.createCanvasFromMedia=Z,t.drawBox=Q,t.drawDetection=function(t,e,f){var n=V.getEnv().Canvas,h=rt(t);if(!(h instanceof n))throw new Error("drawDetection - expected canvas to be of type: HTMLCanvasElement");(Array.isArray(e)?e:[e]).forEach(function(t){var e=t instanceof k?t.box:t,n=e.x,r=e.y,o=e.width,i=e.height,a=K(f),c=J(h);Q(c,n,r,o,i,a);var s=a.withScore,u=t instanceof $?t.text:s&&t instanceof et?""+m(t.score):t instanceof k?t.className+(s?" ("+m(t.score)+")":""):"";u&&nt(c,n,r+i,u,a)})},t.drawText=nt,t.fetchImage=function(r){return T(this,void 0,void 0,function(){var e,n;return O(this,function(t){switch(t.label){case 0:return[4,ot(r)];case 1:return[4,(e=t.sent()).blob()];case 2:if(!(n=t.sent()).type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+n.type+", for url: "+e.url);return[2,q(n)]}})})},t.fetchJson=it,t.fetchNetWeights=function(n){return T(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e=Float32Array.bind,[4,ot(n)];case 1:return[4,t.sent().arrayBuffer()];case 2:return[2,new(e.apply(Float32Array,[void 0,t.sent()]))]}})})},t.fetchOrThrow=ot,t.getContext2dOrThrow=J,t.getDefaultDrawOptions=K,t.getMediaDimensions=G,t.imageTensorToCanvas=at,t.imageToSquare=ct,t.isMediaElement=st,t.isMediaLoaded=Y,t.loadWeightMap=ut,t.NetInput=ht,t.resolveInput=rt,t.toNetInput=pt,t.env=V,t.sigmoid=gt,t.inverseSigmoid=function(t){return Math.log(t/(1-t))},t.iou=dt,t.nonMaxSuppression=vt,t.normalize=mt,t.padToSquare=ft,t.shuffleArray=function(t){for(var e=t.slice(),n=e.length-1;0<n;n--){var r=Math.floor(Math.random()*(n+1)),o=e[n];e[n]=e[r],e[r]=o}return e},t.isTensor=a,t.isTensor1D=function(t){return a(t,1)},t.isTensor2D=P,t.isTensor3D=c,t.isTensor4D=f,t.isFloat=h,t.isEven=d,t.round=m,t.isDimensions=r,t.computeReshapedDimensions=n,t.getCenterPoint=v,t.range=s,t.isValidNumber=g,t.isValidProbablitiy=b,t.NeuralNetwork=lt,t.FaceDetection=It,t.FaceLandmarks=Ot,t.FaceLandmarks5=jt,t.FaceLandmarks68=Lt,t.FaceMatch=kt,t.LabeledFaceDescriptors=Nt,t.drawContour=Bt,t.drawLandmarks=function(t,e,n){var r=rt(t);if(!(r instanceof V.getEnv().Canvas))throw new Error("drawLandmarks - expected canvas to be of type: HTMLCanvasElement");var o=Object.assign(K(n),n||{}),i=Object.assign({drawLines:!1},n||{}).drawLines,a=J(r),c=o.lineWidth,s=o.color,u=void 0===s?"blue":s;(Array.isArray(e)?e:[e]).forEach(function(t){if(i&&t instanceof Lt)return a.strokeStyle=u,a.lineWidth=c,Bt(a,t.getJawOutline()),Bt(a,t.getLeftEyeBrow()),Bt(a,t.getRightEyeBrow()),Bt(a,t.getNose()),Bt(a,t.getLeftEye(),!0),Bt(a,t.getRightEye(),!0),void Bt(a,t.getMouth(),!0);var e=c/2;a.fillStyle=u,t.positions.forEach(function(t){return a.fillRect(t.x-e,t.y-e,c,c)})})},t.drawFaceExpressions=function(t,e,n){var s=rt(t);if(!(s instanceof V.getEnv().Canvas))throw new Error("drawFaceExpressions - expected canvas to be of type: HTMLCanvasElement");var r=Object.assign(K(n),n||{}),u=J(s),o=r.primaryColor,f=void 0===o?"red":o,i=r.secondaryColor,h=void 0===i?"blue":i,a=r.primaryFontSize,p=void 0===a?22:a,c=r.secondaryFontSize,l=void 0===c?16:c,d=r.minConfidence,v=void 0===d?.2:d;(Array.isArray(e)?e:[e]).forEach(function(t){var e=t.position,n=t.expressions,r=e.x,o=e.y,i=e.height||0,a=n.sort(function(t,e){return e.probability-t.probability}).filter(function(t){return t.probability>v}),c=o+i+a.length*p>s.height?-a.length*p:0;a.forEach(function(t,e){var n=t.expression+" ("+m(t.probability)+")";nt(u,r,o+i+e*p+c,n,{textColor:0===e?f:h,fontSize:0===e?p:l})})})},t.extractFaces=Wt,t.extractFaceTensors=At,t.FaceExpressionNet=Xt,t.faceExpressionLabels=Gt,t.FaceLandmarkNet=te,t.FaceLandmark68Net=Kt,t.FaceLandmark68TinyNet=$t,t.createFaceRecognitionNet=function(t){var e=new se;return e.extractWeights(t),e},t.FaceRecognitionNet=se,t.extendWithFaceDescriptor=ue,t.extendWithFaceDetection=fe,t.extendWithFaceExpressions=he,t.extendWithFaceLandmarks=pe,t.allFacesSsdMobilenetv1=mn,t.allFacesTinyYolov2=function(e,n){return void 0===n&&(n={}),T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,vn(e,new Dt(n)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})},t.allFacesMtcnn=function(e,n){return void 0===n&&(n={}),T(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,vn(e,new le(n)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})},t.allFaces=gn,t.ComposableTask=De,t.ComputeFaceDescriptorsTaskBase=nn,t.ComputeAllFaceDescriptorsTask=rn,t.ComputeSingleFaceDescriptorTask=on,t.detectSingleFace=function(t,e){return void 0===e&&(e=new xe),new dn(t,e)},t.detectAllFaces=vn,t.DetectFacesTaskBase=pn,t.DetectAllFacesTask=ln,t.DetectSingleFaceTask=dn,t.DetectFaceLandmarksTaskBase=an,t.DetectAllFaceLandmarksTask=cn,t.DetectSingleFaceLandmarksTask=sn,t.FaceMatcher=yn,t.nets=Xe,t.ssdMobilenetv1=Ze,t.tinyFaceDetector=function(t,e){return Xe.tinyFaceDetector.locateFaces(t,e)},t.tinyYolov2=function(t,e){return Xe.tinyYolov2.locateFaces(t,e)},t.mtcnn=function(t,e){return Xe.mtcnn.forward(t,e)},t.detectFaceLandmarks=Ke,t.detectFaceLandmarksTiny=function(t){return Xe.faceLandmark68TinyNet.detectLandmarks(t)},t.computeFaceDescriptor=function(t){return Xe.faceRecognitionNet.computeFaceDescriptor(t)},t.recognizeFaceExpressions=function(t){return Xe.faceExpressionNet.predictExpressions(t)},t.loadSsdMobilenetv1Model=Qe,t.loadTinyFaceDetectorModel=function(t){return Xe.tinyFaceDetector.load(t)},t.loadMtcnnModel=function(t){return Xe.mtcnn.load(t)},t.loadTinyYolov2Model=function(t){return Xe.tinyYolov2.load(t)},t.loadFaceLandmarkModel=function(t){return Xe.faceLandmark68Net.load(t)},t.loadFaceLandmarkTinyModel=function(t){return Xe.faceLandmark68TinyNet.load(t)},t.loadFaceRecognitionModel=function(t){return Xe.faceRecognitionNet.load(t)},t.loadFaceExpressionModel=function(t){return Xe.faceExpressionNet.load(t)},t.loadFaceDetectionModel=$e,t.locateFaces=tn,t.detectLandmarks=en,t.createMtcnn=function(t){var e=new Re;return e.extractWeights(t),e},t.Mtcnn=Re,t.MtcnnOptions=le,t.createSsdMobilenetv1=Ee,t.createFaceDetectionNet=function(t){return Ee(t)},t.FaceDetectionNet=Fe,t.SsdMobilenetv1=Pe,t.SsdMobilenetv1Options=xe,t.createTinyFaceDetector=function(t){var e=new Ye;return e.extractWeights(t),e},t.TinyFaceDetector=Ye,t.TinyFaceDetectorOptions=Me,t.TinyYolov2=Ge,t.createTinyYolov2=function(t,e){void 0===e&&(e=!0);var n=new Ge(e);return n.extractWeights(t),n},t.euclideanDistance=bn,t.resizeResults=function e(t,n){var r=n.width,o=n.height;if(Array.isArray(t))return t.map(function(t){return e(t,{width:r,height:o})});var i=t.unshiftedLandmarks&&t.unshiftedLandmarks instanceof Ot,a=t.detection&&t.detection instanceof It;if(i){var c=t.detection.forSize(r,o),s=t.unshiftedLandmarks.forSize(c.box.width,c.box.height);return pe(fe(t,c),s)}return a?fe(t,t.detection.forSize(r,o)):t instanceof Ot||t instanceof It?t.forSize(r,o):t},Object.defineProperty(t,"__esModule",{value:!0})});
